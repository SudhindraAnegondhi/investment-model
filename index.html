<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Rental Property Investment Model</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>

    <!-- CSS Files -->
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/responsive.css" />
  </head>
  <body>
    <div class="container">
      <div class="app-header">
        <h1 class="app-title">Advanced Rental Property Investment Model</h1>
        <div class="app-subtitle" id="app-subtitle" style="display: none">
          <span class="location-icon">📍</span>
          <span id="location-text">Real estate analysis</span>
        </div>
      </div>

      <div class="tab-navigation">
        <!-- Mobile/Responsive Tab Menu -->
        <div class="tab-menu-container">
          <button class="tab-menu-toggle" onclick="toggleTabMenu()">
            <span class="menu-icon">☰</span>
            <span class="current-tab-name">Input Parameters</span>
            <span class="menu-arrow">▼</span>
          </button>
          <div class="tab-dropdown" id="tabDropdown">
            <button
              class="tab-option active"
              data-tab="inputs"
              onclick="selectTab('inputs', 'Input Parameters')"
            >
              📝 Input Parameters
            </button>
            <button
              class="tab-option"
              data-tab="dashboard"
              onclick="selectTab('dashboard', '📊 Dashboard')"
            >
              📊 Dashboard
            </button>
            <button
              class="tab-option"
              data-tab="charts"
              onclick="selectTab('charts', '📈 Charts & Analysis')"
            >
              📈 Charts & Analysis
            </button>
            <button
              class="tab-option"
              data-tab="scenarios"
              onclick="selectTab('scenarios', '💾 Scenarios')"
            >
              💾 Scenarios
            </button>
            <button
              class="tab-option"
              data-tab="comparison"
              onclick="selectTab('comparison', 'Strategy Comparison')"
            >
              📊 Strategy Comparison
            </button>
            <button
              class="tab-option"
              data-tab="cashflow"
              onclick="selectTab('cashflow', 'Cash Flow Analysis')"
            >
              💰 Cash Flow Analysis
            </button>
            <button
              class="tab-option"
              data-tab="sensitivity"
              onclick="selectTab('sensitivity', 'Sensitivity Analysis')"
            >
              🎯 Sensitivity Analysis
            </button>
            <button
              class="tab-option"
              data-tab="breakeven"
              onclick="selectTab('breakeven', 'Break-Even Analysis')"
            >
              ⚖️ Break-Even Analysis
            </button>
            <button
              class="tab-option"
              data-tab="roi"
              onclick="selectTab('roi', 'ROI Analysis')"
            >
              📈 ROI Analysis
            </button>
            <button
              class="tab-option"
              data-tab="help"
              onclick="selectTab('help', 'Help')"
            >
              ❓ Help
            </button>
          </div>
        </div>

        <!-- Navigation Menu -->
        <div class="nav-menu">
          <div class="menu-dropdown">
            <button class="menu-button" onclick="toggleNavMenu()">
              <span class="menu-icon">⚙️</span>
              <span class="current-tab-label">📊 Dashboard</span>
              <span class="dropdown-arrow">▼</span>
            </button>
            <div class="dropdown-content" id="nav-dropdown">
              <button onclick="selectTab('inputs', '⚙️ Settings')">
                ⚙️ Settings
              </button>
              <button
                onclick="selectTab('dashboard', '📊 Dashboard')"
                class="active-menu-item"
              >
                📊 Dashboard
              </button>
              <button onclick="selectTab('charts', '📈 Charts & Analysis')">
                📈 Charts & Analysis
              </button>
              <button onclick="selectTab('scenarios', '💾 Scenarios')">
                💾 Scenarios
              </button>
              <button
                onclick="selectTab('comparison', '📊 Strategy Comparison')"
              >
                📊 Strategy Comparison
              </button>
              <button onclick="selectTab('cashflow', '💰 Cash Flow Analysis')">
                💰 Cash Flow Analysis
              </button>
              <button
                onclick="selectTab('sensitivity', '🎯 Sensitivity Analysis')"
              >
                🎯 Sensitivity Analysis
              </button>
              <button
                onclick="selectTab('breakeven', '⚖️ Break-Even Analysis')"
              >
                ⚖️ Break-Even Analysis
              </button>
              <button onclick="selectTab('roi', '📈 ROI Analysis')">
                📈 ROI Analysis
              </button>
              <button onclick="selectTab('help', '❓ Help')">❓ Help</button>
            </div>
          </div>
        </div>
      </div>

      <div id="inputs" class="tab-content">
        <div class="input-form-container">
          <!-- Scrollable Form Area -->
          <div class="form-scroll-area">
            <div class="controls">
              <!-- AI Market Data Section -->
              <div class="control-group ai-controls">
                <h3>🤖 AI Market Analysis</h3>
                <div class="ai-toggle-section">
                  <label class="ai-toggle-label">
                    <input
                      type="checkbox"
                      id="useAIData"
                      onchange="toggleAIDataAndSubtitle()"
                    />
                    <span class="ai-toggle-slider"></span>
                    Enable AI-Enhanced Market Projections
                  </label>
                  <div class="ai-status" id="ai-status">
                    Static model - Enable AI for real market data
                  </div>
                </div>

                <div class="ai-settings" id="ai-settings" style="display: none">
                  <div class="control-group">
                    <h4>📍 Property Location</h4>
                    <div class="location-inputs">
                      <input
                        type="text"
                        id="city"
                        placeholder="City (e.g., Austin)"
                        style="width: 120px"
                      />
                      <select id="state" style="width: 100px">
                        <option value="">State</option>
                        <option value="California">CA</option>
                        <option value="Texas">TX</option>
                        <option value="Florida">FL</option>
                        <option value="New York">NY</option>
                        <option value="Illinois">IL</option>
                        <option value="Georgia">GA</option>
                        <option value="North Carolina">NC</option>
                        <option value="Arizona">AZ</option>
                        <option value="Colorado">CO</option>
                        <option value="Washington">WA</option>
                        <option value="Oregon">OR</option>
                      </select>
                      <input
                        type="text"
                        id="zipCode"
                        placeholder="ZIP (optional)"
                        style="width: 100px"
                      />
                    </div>
                  </div>

                  <div class="control-group">
                    <label for="propertyType">🏠 Property Type</label>
                    <select id="propertyType">
                      <option value="single-family">Single Family Home</option>
                      <option value="condo">Condominium</option>
                      <option value="townhouse">Townhouse</option>
                      <option value="multi-family">
                        Multi-Family (2-4 units)
                      </option>
                    </select>
                  </div>

                  <div class="control-group">
                    <h4>📊 AI Data Sources & Overrides</h4>
                    <div class="ai-overrides">
                      <div class="ai-setting-row">
                        <label class="ai-checkbox-label">
                          <input
                            type="checkbox"
                            id="useAIAppreciation"
                            checked
                          />
                          Property Price Trends (AI)
                        </label>
                        <div
                          class="override-input"
                          id="appreciationOverride"
                          style="display: none"
                        >
                          <label>Override:</label>
                          <input
                            type="number"
                            id="overrideAppreciation"
                            step="0.1"
                            min="0"
                            max="15"
                            placeholder="3.5"
                          />
                          <span>%/year</span>
                        </div>
                      </div>

                      <div class="ai-setting-row">
                        <label class="ai-checkbox-label">
                          <input type="checkbox" id="useAIRentGrowth" checked />
                          Rent Growth Projections (AI)
                        </label>
                        <div
                          class="override-input"
                          id="rentGrowthOverride"
                          style="display: none"
                        >
                          <label>Override:</label>
                          <input
                            type="number"
                            id="overrideRentGrowth"
                            step="0.1"
                            min="0"
                            max="10"
                            placeholder="2.8"
                          />
                          <span>%/year</span>
                        </div>
                      </div>

                      <div class="ai-setting-row">
                        <label class="ai-checkbox-label">
                          <input
                            type="checkbox"
                            id="useAIInterestRates"
                            checked
                          />
                          Interest Rate Forecasts (AI)
                        </label>
                        <div
                          class="override-input"
                          id="interestRateOverride"
                          style="display: none"
                        >
                          <label>Override:</label>
                          <input
                            type="number"
                            id="overrideInterestRate"
                            step="0.1"
                            min="1"
                            max="15"
                            placeholder="6.75"
                          />
                          <span>%</span>
                        </div>
                      </div>

                      <div class="ai-setting-row">
                        <label class="ai-checkbox-label">
                          <input
                            type="checkbox"
                            id="useAIMarketInsights"
                            checked
                          />
                          Market Insights & Risk Analysis (AI)
                        </label>
                      </div>
                    </div>

                    <div class="control-group" style="margin-top: 20px">
                      <h4>
                        🏦 Financing Profile for Interest Rate Predictions
                      </h4>

                      <div class="financing-profile">
                        <div class="finance-source-section">
                          <label class="finance-source-label"
                            >💰 Financing Source</label
                          >
                          <div class="finance-source-toggle">
                            <label class="toggle-option">
                              <input
                                type="radio"
                                name="financeSource"
                                value="bank"
                                checked
                              />
                              <span class="toggle-text"
                                >🏛️ Traditional Bank</span
                              >
                            </label>
                            <label class="toggle-option">
                              <input
                                type="radio"
                                name="financeSource"
                                value="private"
                              />
                              <span class="toggle-text">🤝 Private Lender</span>
                            </label>
                          </div>
                          <div
                            class="finance-source-description"
                            id="financeSourceDescription"
                          >
                            Lower rates, stricter requirements, longer
                            processing
                          </div>
                        </div>

                        <div class="modern-slider-card">
                          <div class="slider-card-header">
                            <div class="slider-icon">📊</div>
                            <div class="slider-title">
                              <h4>Credit Score Range</h4>
                              <div class="slider-subtitle">
                                Impact on interest rates
                              </div>
                            </div>
                          </div>

                          <div class="modern-slider-container">
                            <div class="slider-track-container">
                              <input
                                type="range"
                                id="creditScore"
                                min="0"
                                max="3"
                                value="2"
                                step="1"
                                class="modern-slider credit-score-slider"
                              />
                              <div class="slider-track-bg">
                                <div class="track-segment poor"></div>
                                <div class="track-segment fair"></div>
                                <div class="track-segment good"></div>
                                <div class="track-segment excellent"></div>
                              </div>
                            </div>

                            <div class="slider-options">
                              <div class="slider-option" data-value="0">
                                <div class="option-dot poor">⚠️</div>
                                <div class="option-label">
                                  <span class="option-title">Poor</span>
                                  <span class="option-range">300-579</span>
                                </div>
                              </div>
                              <div class="slider-option" data-value="1">
                                <div class="option-dot fair">⚡</div>
                                <div class="option-label">
                                  <span class="option-title">Fair</span>
                                  <span class="option-range">580-669</span>
                                </div>
                              </div>
                              <div class="slider-option active" data-value="2">
                                <div class="option-dot good">✅</div>
                                <div class="option-label">
                                  <span class="option-title">Good</span>
                                  <span class="option-range">670-739</span>
                                </div>
                              </div>
                              <div class="slider-option" data-value="3">
                                <div class="option-dot excellent">⭐</div>
                                <div class="option-label">
                                  <span class="option-title">Excellent</span>
                                  <span class="option-range">740+</span>
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="slider-feedback">
                            <div class="feedback-badge" id="creditScoreBadge">
                              Good Credit
                            </div>
                            <div class="feedback-description" id="creditImpact">
                              Expect competitive rates with good qualification
                              requirements
                            </div>
                          </div>
                        </div>

                        <div class="modern-slider-card">
                          <div class="slider-card-header">
                            <div class="slider-icon">🏦</div>
                            <div class="slider-title">
                              <h4>Financing Product Type</h4>
                              <div class="slider-subtitle">
                                Structure and rate characteristics
                              </div>
                            </div>
                          </div>

                          <div class="modern-slider-container">
                            <div class="slider-track-container">
                              <input
                                type="range"
                                id="financingType"
                                min="0"
                                max="1"
                                value="0"
                                step="1"
                                class="modern-slider financing-type-slider"
                              />
                              <div class="slider-track-bg financing-track">
                                <div class="track-segment mortgage"></div>
                                <div class="track-segment credit-line"></div>
                              </div>
                            </div>

                            <div class="slider-options financing-options">
                              <div class="slider-option active" data-value="0">
                                <div class="option-dot mortgage">🏠</div>
                                <div class="option-label">
                                  <span class="option-title"
                                    >Traditional Mortgage</span
                                  >
                                  <span class="option-range"
                                    >Fixed/ARM, 15-30yr terms</span
                                  >
                                </div>
                              </div>
                              <div class="slider-option" data-value="1">
                                <div class="option-dot credit-line">💳</div>
                                <div class="option-label">
                                  <span class="option-title">Credit Line</span>
                                  <span class="option-range"
                                    >HELOC/LOC, flexible draw</span
                                  >
                                </div>
                              </div>
                            </div>
                          </div>

                          <div class="slider-feedback">
                            <div class="feedback-badge" id="financingTypeBadge">
                              Traditional Mortgage
                            </div>
                            <div
                              class="feedback-description"
                              id="financingTypeImpact"
                            >
                              Lower rates with structured payments and
                              amortization schedule
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <div class="override-help">
                      <small
                        >💡 Tip: Uncheck AI sources to use your own specific
                        rates while keeping other AI enhancements active</small
                      >
                    </div>
                  </div>

                  <div
                    class="ai-data-preview"
                    id="ai-data-preview"
                    style="display: none"
                  >
                    <h4>📈 Current AI Projections</h4>
                    <div class="ai-preview-content">
                      <!-- Will be populated when AI data is fetched -->
                    </div>
                  </div>
                </div>
              </div>

              <div class="control-group">
                <h4>💰 Investment Budget Strategy</h4>
                <div class="budget-mode-selection">
                  <label class="budget-mode-option">
                    <input
                      type="radio"
                      name="budgetMode"
                      value="predetermined"
                      checked
                    />
                    <span class="radio-label">Predetermined Annual Budget</span>
                    <small>Fixed amount invested each year</small>
                  </label>
                  <label class="budget-mode-option">
                    <input type="radio" name="budgetMode" value="needsBased" />
                    <span class="radio-label">Needs-Based Investment</span>
                    <small
                      >Invest optimal amounts when opportunities arise</small
                    >
                  </label>
                </div>
              </div>

              <div class="control-group" id="predeterminedBudgetControls">
                <label>Annual Investment Budget ($)</label>
                <input type="number" id="annualBudget" value="170000" min="0" />
              </div>

              <div
                class="control-group"
                id="needsBasedControls"
                style="display: none"
              >
                <label>Investment Objective</label>
                <select id="investmentObjective">
                  <option value="maxCashFlow">🏠 Maximize Cash Flow</option>
                  <option value="maxTotalReturn">
                    📈 Maximize Total Return
                  </option>
                  <option value="maxROI">⚡ Maximize ROI</option>
                  <option value="maxPortfolioSize">
                    🏘️ Maximize Portfolio Size
                  </option>
                  <option value="balanced" selected>⚖️ Balanced Growth</option>
                  <option value="conservative">🛡️ Conservative Growth</option>
                </select>

                <label>Maximum Single Investment ($)</label>
                <input
                  type="number"
                  id="maxSingleInvestment"
                  value="500000"
                  min="0"
                />
                <label>Total Investment Limit ($)</label>
                <input
                  type="number"
                  id="totalInvestmentLimit"
                  value="2000000"
                  min="0"
                />
                <label>Minimum ROI Threshold (%)</label>
                <input
                  type="number"
                  id="minROIThreshold"
                  value="8"
                  min="0"
                  step="0.5"
                />
                <label>Target Annual Cash Flow ($)</label>
                <input
                  type="number"
                  id="targetAnnualCashFlow"
                  value="50000"
                  min="0"
                />
                <label>Risk Tolerance</label>
                <select id="riskTolerance">
                  <option value="conservative">🛡️ Conservative</option>
                  <option value="moderate" selected>⚖️ Moderate</option>
                  <option value="aggressive">🚀 Aggressive</option>
                </select>
              </div>
              <div
                class="control-group highlighted-control"
                style="
                  border: 2px solid #667eea;
                  border-radius: 4px;
                  padding: 8px;
                "
              >
                <label style="color: #667eea; font-weight: bold"
                  >Investment Budget (Years)</label
                >
                <input
                  type="number"
                  id="selfPurchaseYears"
                  value="3"
                  min="0"
                  max="30"
                />
              </div>
              <div class="control-group">
                <label>Initial Property Cost ($)</label>
                <input type="number" id="initialCost" value="160000" min="0" />
              </div>
              <div class="control-group">
                <label>Monthly Rent as % of Purchase Price (%)</label>
                <input
                  type="number"
                  id="rentalRate"
                  value="1.9"
                  step="0.1"
                  min="0"
                />
              </div>
              <div class="control-group">
                <label>Mortgage Interest Rate (%)</label>
                <input
                  type="number"
                  id="interestRate"
                  value="7.00"
                  step="0.01"
                  min="0"
                />
              </div>
              <div class="control-group">
                <label>Loan-to-Value Ratio (%)</label>
                <input
                  type="number"
                  id="ltvRatio"
                  value="70"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Loan Term (Years)</label>
                <input type="number" id="loanTerm" value="5" min="1" max="30" />
              </div>
              <div class="control-group">
                <label>Insurance per Unit per Year ($)</label>
                <input type="number" id="insurance" value="1300" min="0" />
              </div>
              <div class="control-group">
                <label>Land Value (% of cost)</label>
                <input
                  type="number"
                  id="landPercent"
                  value="20"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Maintenance (% of Effective Gross Income)</label>
                <input
                  type="number"
                  id="maintenanceRate"
                  value="1"
                  step="0.1"
                  min="0"
                />
              </div>
              <div class="control-group">
                <label>Annual Purchase Cost Increase (%)</label>
                <input
                  type="number"
                  id="costIncrease"
                  value="1"
                  step="0.1"
                  min="0"
                />
              </div>
              <div class="control-group">
                <label>Property Tax Rate (% of assessed value)</label>
                <input
                  type="number"
                  id="taxRate"
                  value="1.5"
                  step="0.1"
                  min="0"
                  max="10"
                />
              </div>
              <div class="control-group">
                <label>Income Tax Rate (%)</label>
                <input
                  type="number"
                  id="incomeTaxRate"
                  value="25"
                  min="0"
                  max="50"
                />
              </div>
              <div
                class="control-group highlighted-control"
                style="
                  border: 2px solid #28a745;
                  border-radius: 4px;
                  padding: 8px;
                "
              >
                <label style="color: #28a745; font-weight: bold"
                  >Passthrough LLC?</label
                >
                <select id="passthroughLLC" style="border-color: #28a745">
                  <option value="yes">Yes - No entity taxes</option>
                  <option value="no">No - Corporate taxation</option>
                </select>
              </div>
              <div class="control-group">
                <label>Assessed Value at Purchase (% of cost)</label>
                <input
                  type="number"
                  id="assessedValuePercent"
                  value="20"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Annual Property Appreciation (%)</label>
                <input
                  type="number"
                  id="appreciationRate"
                  value="3"
                  step="0.1"
                  min="0"
                />
              </div>
              <div
                class="control-group highlighted-control"
                style="
                  border: 2px solid #667eea;
                  border-radius: 4px;
                  padding: 8px;
                "
              >
                <label style="color: #667eea; font-weight: bold"
                  >Finance Purchases (Years)</label
                >
                <input
                  type="number"
                  id="financedPurchaseYears"
                  value="5"
                  min="0"
                  max="30"
                />
              </div>
              <div
                class="control-group highlighted-control"
                style="
                  border: 2px solid #667eea;
                  border-radius: 4px;
                  padding: 8px;
                "
              >
                <label style="color: #667eea; font-weight: bold"
                  >Max Units Financed</label
                >
                <input
                  type="number"
                  id="maxUnitsFinanced"
                  value="2"
                  min="1"
                  max="10"
                />
              </div>
              <div
                class="control-group highlighted-control"
                style="
                  border: 2px solid #667eea;
                  border-radius: 4px;
                  padding: 8px;
                "
              >
                <label style="color: #667eea; font-weight: bold"
                  >Max Units Financed Limit (Years)</label
                >
                <input
                  type="number"
                  id="maxUnitsFinancedLimitYears"
                  value="3"
                  min="1"
                  max="10"
                />
              </div>
              <div class="control-group">
                <label>Annual Rent Growth (%)</label>
                <input
                  type="number"
                  id="rentGrowthRate"
                  value="3"
                  step="0.1"
                  min="0"
                />
              </div>
              <div class="control-group">
                <label>Vacancy Rate (% of GPR)</label>
                <input
                  type="number"
                  id="vacancyRate"
                  value="5"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Management Fee (% of EGI)</label>
                <input
                  type="number"
                  id="managementRate"
                  value="8"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>CapEx Reserves (% of EGI)</label>
                <input
                  type="number"
                  id="capexRate"
                  value="5"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Expense Inflation (Insurance/Other) (%)</label>
                <input
                  type="number"
                  id="expenseInflation"
                  value="2.5"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Insurance Inflation (%)</label>
                <input
                  type="number"
                  id="insuranceInflation"
                  value="4"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Closing Costs (% of Purchase Price)</label>
                <input
                  type="number"
                  id="closingCostPercent"
                  value="2"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Loan Origination Fee (% of Loan)</label>
                <input
                  type="number"
                  id="loanOriginationPercent"
                  value="1"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Assessed Value Growth (%)</label>
                <input
                  type="number"
                  id="assessedGrowthRate"
                  value="2.5"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
            </div>
          </div>

          <!-- Fixed Calculate Button Area -->
          <div class="calculate-button-area">
            <button class="calculate-btn" onclick="calculateAll()">
              Calculate Investment Scenarios
            </button>
          </div>
        </div>

        <!-- Current Scenario Display -->
        <div id="current-scenario" style="display: none"></div>
      </div>

      <!-- Dashboard Tab -->
      <div id="dashboard" class="tab-content active">
        <h2>📊 Investment Dashboard</h2>

        <!-- Alert System -->
        <div id="alert-container" class="alert-container"></div>

        <!-- Enhanced Key Performance Indicators - Moved to top -->
        <div class="dashboard-section kpi-section">
          <div class="kpi-header">
            <h3>🎯 Strategy Comparison Metrics</h3>
            <p class="kpi-subtitle">
              Bank-Financed vs Self-Financed Strategy Performance
            </p>
          </div>
          <div class="insights-grid enhanced">
            <div class="insight-card net-worth-card">
              <div class="insight-icon">⚖️</div>
              <div class="insight-content">
                <div class="insight-label">Net Worth Advantage</div>
                <div class="insight-value" id="dash-net-worth-diff">-</div>
                <div class="insight-percentage" id="dash-net-worth-percent">
                  -
                </div>
                <div class="insight-description">
                  Bank-Financed vs Self-Financed
                </div>
              </div>
            </div>
            <div class="insight-card units-card">
              <div class="insight-icon">📈</div>
              <div class="insight-content">
                <div class="insight-label">Portfolio Growth</div>
                <div class="insight-value" id="dash-unit-diff">-</div>
                <div class="insight-percentage" id="dash-unit-percent">-</div>
                <div class="insight-description">
                  Additional units with leverage
                </div>
              </div>
            </div>
            <div class="insight-card cashflow-card">
              <div class="insight-icon">💵</div>
              <div class="insight-content">
                <div class="insight-label">Cash Flow Impact</div>
                <div class="insight-value" id="dash-cash-flow-diff">-</div>
                <div class="insight-percentage" id="dash-cash-flow-percent">
                  -
                </div>
                <div class="insight-description">
                  Bank-Financed vs Self-Financed
                </div>
              </div>
            </div>
            <div class="insight-card leverage-card">
              <div class="insight-icon">🎯</div>
              <div class="insight-content">
                <div class="insight-label">Leverage Multiplier</div>
                <div class="insight-value" id="dash-leverage-multiplier">
                  1.0x
                </div>
                <div class="insight-percentage" id="dash-leverage-percent">
                  -
                </div>
                <div class="insight-description">
                  Asset control per equity dollar
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Investment Model Synopsis -->
        <div class="dashboard-section" id="model-synopsis-section">
          <h3>📋 Investment Model Synopsis</h3>
          <div id="model-synopsis-content">
            <!-- Content will be dynamically populated -->
          </div>
        </div>

        <!-- Enhanced Strategy Comparison -->
        <div class="dashboard-section">
          <h3>📊 Strategy Performance Overview</h3>
          <div class="strategy-comparison-grid">
            <!-- Self-Financed Strategy -->
            <div class="strategy-card self-financed">
              <div class="strategy-header">
                <div class="strategy-icon">🏦</div>
                <div class="strategy-info">
                  <h4>Self-Financed Strategy</h4>
                  <p>Pay cash, own outright</p>
                </div>
              </div>
              <div class="strategy-metrics">
                <div class="metric-card">
                  <div class="metric-icon">🏘️</div>
                  <div class="metric-info">
                    <div class="metric-label">Total Units</div>
                    <div class="metric-value" id="dash-self-units">0</div>
                  </div>
                </div>
                <div class="metric-card">
                  <div class="metric-icon">💎</div>
                  <div class="metric-info">
                    <div class="metric-label">Final Net Worth</div>
                    <div class="metric-value" id="self-net-worth">$0</div>
                  </div>
                </div>
                <div class="metric-card">
                  <div class="metric-icon">💰</div>
                  <div class="metric-info">
                    <div class="metric-label">Cumulative Cash Flow</div>
                    <div class="metric-value" id="self-cash-flow">$0</div>
                  </div>
                </div>
                <div class="metric-card">
                  <div class="metric-icon">📈</div>
                  <div class="metric-info">
                    <div class="metric-label">Total ROI</div>
                    <div class="metric-value" id="self-roi">0%</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Bank-Financed Strategy -->
            <div class="strategy-card bank-financed">
              <div class="strategy-header">
                <div class="strategy-icon">🏛️</div>
                <div class="strategy-info">
                  <h4>Bank-Financed Strategy</h4>
                  <p>Leverage with mortgages</p>
                </div>
              </div>
              <div class="strategy-metrics">
                <div class="metric-card">
                  <div class="metric-icon">🏘️</div>
                  <div class="metric-info">
                    <div class="metric-label">Total Units</div>
                    <div class="metric-value" id="dash-financed-units">0</div>
                  </div>
                </div>
                <div class="metric-card">
                  <div class="metric-icon">💎</div>
                  <div class="metric-info">
                    <div class="metric-label">Final Net Worth</div>
                    <div class="metric-value" id="financed-net-worth">$0</div>
                  </div>
                </div>
                <div class="metric-card">
                  <div class="metric-icon">💰</div>
                  <div class="metric-info">
                    <div class="metric-label">Cumulative Cash Flow</div>
                    <div class="metric-value" id="financed-cash-flow">$0</div>
                  </div>
                </div>
                <div class="metric-card">
                  <div class="metric-icon">📈</div>
                  <div class="metric-info">
                    <div class="metric-label">Total ROI</div>
                    <div class="metric-value" id="financed-roi">0%</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Comparison Cards -->
        <div class="comparison-cards">
          <div class="comparison-card self-financed">
            <h4>🏠 Self-Financed Advantage</h4>
            <div class="comparison-metrics">
              <div class="metric">
                <div class="metric-label">Net Worth Advantage</div>
                <div class="metric-value" id="net-worth-diff">$0</div>
              </div>
              <div class="metric">
                <div class="metric-label">Cash Flow Advantage</div>
                <div class="metric-value" id="cash-flow-diff">$0</div>
              </div>
            </div>
          </div>

          <div class="comparison-card financed">
            <h4>🏦 Bank-Financed Benefits</h4>
            <div class="comparison-metrics">
              <div class="metric">
                <div class="metric-label">Leverage Multiplier</div>
                <div class="metric-value" id="leverage-multiplier">1.0x</div>
                <div class="metric-description">
                  Asset control per equity dollar
                </div>
              </div>
              <div class="metric">
                <div class="metric-label">Unit Efficiency</div>
                <div class="metric-value" id="units-per-dollar">0.0</div>
                <div class="metric-description">
                  Units acquired per $1K invested
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Negative Cash Flow Analysis -->
        <div
          class="dashboard-section"
          id="negative-cashflow-section"
          style="display: none"
        >
          <h3>⚠️ Cash Flow Challenges</h3>
          <div class="alert-warning" style="margin-bottom: 15px">
            <strong>Negative Cash Flow Years Detected</strong><br />
            Some years show negative closing cash flow, which may require
            additional funding or cash reserves.
          </div>
          <div class="comparison-cards" id="negative-cashflow-cards">
            <div
              class="comparison-card"
              id="self-negative-card"
              style="border-left: 4px solid #ff6b6b; display: none"
            >
              <h4>💰 Self-Financed Strategy</h4>
              <div id="self-negative-years" class="negative-years-list">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
            <div
              class="comparison-card"
              id="financed-negative-card"
              style="border-left: 4px solid #ff6b6b; display: none"
            >
              <h4>🏦 Bank-Financed Strategy</h4>
              <div id="financed-negative-years" class="negative-years-list">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>

        <!-- AI Market Insights -->
        <div
          class="dashboard-section"
          id="ai-insights-section"
          style="display: none"
        >
          <h3>🤖 AI Market Analysis</h3>
          <div class="ai-insights-container">
            <div class="ai-insight-card">
              <h4>📊 Market Conditions</h4>
              <div id="ai-market-conditions" class="ai-insight-content">
                <!-- Will be populated by AI analysis -->
              </div>
            </div>
            <div class="ai-insight-card">
              <h4>⚠️ Risk Factors</h4>
              <div id="ai-risk-factors" class="ai-insight-content">
                <!-- Will be populated by AI analysis -->
              </div>
            </div>
            <div class="ai-insight-card">
              <h4>🎯 Investment Opportunities</h4>
              <div id="ai-opportunities" class="ai-insight-content">
                <!-- Will be populated by AI analysis -->
              </div>
            </div>
          </div>
          <div class="ai-data-source">
            <small
              >💡 AI analysis based on current market data and trends for
              <span id="ai-location-display"></span
            ></small>
          </div>
        </div>

        <!-- Additional Cash Injections Analysis -->
        <div
          class="dashboard-section"
          id="cash-injections-section"
          style="display: none"
        >
          <h3>💰 Additional Cash Injections Required</h3>
          <div class="alert-info" style="margin-bottom: 15px">
            <strong>Needs-Based Investment Strategy</strong><br />
            Based on ROI thresholds and optimal investment timing, here are the
            additional cash injections required.
          </div>
          <div class="table-container">
            <table class="cash-injections-table">
              <thead>
                <tr>
                  <th>Year</th>
                  <th>Cash Injection</th>
                  <th>Projected ROI</th>
                  <th>Cumulative Investment</th>
                  <th>Investment Reason</th>
                </tr>
              </thead>
              <tbody id="cash-injections-tbody">
                <!-- Will be populated dynamically -->
              </tbody>
              <tfoot id="cash-injections-summary">
                <tr class="summary-row">
                  <td><strong>Total</strong></td>
                  <td><strong id="total-cash-injections">$0</strong></td>
                  <td><strong id="avg-projected-roi">0%</strong></td>
                  <td><strong id="final-cumulative-investment">$0</strong></td>
                  <td>Investment Summary</td>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="cash-injection-insights">
            <div class="insight-card">
              <h4>📈 Investment Strategy</h4>
              <div id="investment-strategy-summary">
                <!-- Will be populated with investment strategy analysis -->
              </div>
            </div>
          </div>
        </div>

        <!-- Recommendation Section -->
        <div
          id="dashboard-recommendation"
          class="dashboard-section recommendation-section"
          style="display: none"
        >
          <h3>💡 Strategic Recommendations</h3>
          <div id="dashboard-recommendation-content">
            <!-- Content will be dynamically populated -->
          </div>
        </div>

        <!-- Quick Actions & Export -->
        <div class="dashboard-section">
          <h3>🚀 Quick Actions & Export</h3>
          <div class="action-buttons-grid">
            <!-- Analysis Actions -->
            <div class="action-group">
              <h4>📊 Analysis Tools</h4>
              <div style="display: flex; gap: 10px; flex-wrap: wrap">
                <button
                  class="btn btn-secondary"
                  onclick="workerManager.performSensitivityAnalysis(utils.getInputParameters())"
                >
                  🎯 Sensitivity Analysis
                </button>
                <button
                  class="btn btn-secondary"
                  onclick="workerManager.performMonteCarloSimulation(utils.getInputParameters())"
                >
                  🎲 Monte Carlo Simulation
                </button>
              </div>
            </div>

            <!-- Save & Export Actions -->
            <div class="action-group">
              <h4>💾 Save & Export</h4>
              <div style="display: flex; gap: 10px; flex-wrap: wrap">
                <button
                  class="btn btn-primary"
                  onclick="scenarioManager.showSaveDialog()"
                >
                  💾 Save Scenario
                </button>
                <button class="btn btn-success" onclick="downloadExcel()">
                  📊 Download Excel
                </button>
                <button
                  class="btn btn-success"
                  onclick="exportCurrentResultsToPDF()"
                >
                  📄 Export PDF Report
                </button>
                <button class="btn btn-secondary" onclick="window.print()">
                  🖨️ Print Summary
                </button>
                <button
                  class="btn btn-warning"
                  onclick="exportSimpleTestPDF()"
                  style="display: none"
                  id="debug-pdf-btn"
                >
                  🔧 Test PDF
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts & Analysis Tab -->
      <div id="charts" class="tab-content">
        <h2>📈 Charts & Visual Analysis</h2>

        <div class="charts-grid">
          <!-- Cash Flow Waterfall Chart -->
          <div class="chart-container">
            <h3>Cash Flow Waterfall Analysis</h3>
            <div class="chart-wrapper">
              <canvas id="cashFlowWaterfallChart"></canvas>
            </div>
          </div>

          <!-- Net Worth Progression Chart -->
          <div class="chart-container">
            <h3>Net Worth & Cash Flow Progression</h3>
            <div class="chart-wrapper">
              <canvas id="netWorthChart"></canvas>
            </div>
          </div>

          <!-- Sensitivity Tornado Chart -->
          <div class="chart-container">
            <h3>Sensitivity Analysis</h3>
            <div class="chart-wrapper">
              <canvas id="sensitivityChart"></canvas>
            </div>
          </div>

          <!-- Loan Tracking Chart -->
          <div class="chart-container">
            <h3>📊 Loan Analysis & Repayment Tracking</h3>
            <div class="chart-wrapper">
              <canvas id="loanTrackingChart"></canvas>
            </div>
            <div class="chart-legend">
              <div class="legend-item">
                <span class="legend-color" style="background: #2196f3"></span>
                <span>New Loans</span>
              </div>
              <div class="legend-item">
                <span class="legend-color" style="background: #ff9800"></span>
                <span>Interest Payments</span>
              </div>
              <div class="legend-item">
                <span class="legend-color" style="background: #4caf50"></span>
                <span>Principal Payments</span>
              </div>
              <div class="legend-item">
                <span class="legend-color" style="background: #f44336"></span>
                <span>Outstanding Balance</span>
              </div>
            </div>
          </div>

          <!-- Cash Injections Chart -->
          <div
            class="chart-container"
            id="cash-injections-chart-container"
            style="display: none"
          >
            <h3>💰 Additional Cash Injections Timeline</h3>
            <div class="chart-wrapper">
              <canvas id="cashInjectionsChart"></canvas>
            </div>
            <div class="chart-legend">
              <div class="legend-item">
                <span class="legend-color" style="background: #dc2626"></span>
                <span>Cash Injection Required</span>
              </div>
              <div class="legend-item">
                <span class="legend-color" style="background: #16a34a"></span>
                <span>Projected ROI</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Advanced Analysis Results -->
        <div id="sensitivity-results"></div>
        <div id="monte-carlo-results"></div>
      </div>

      <!-- Scenarios Tab -->
      <div id="scenarios" class="tab-content">
        <h2>💾 Scenario Management</h2>

        <div class="dashboard-section">
          <h3>Scenario Actions</h3>
          <div
            style="
              display: flex;
              gap: 15px;
              flex-wrap: wrap;
              margin-bottom: 20px;
            "
          >
            <button
              class="btn btn-primary"
              onclick="scenarioManager.showSaveDialog()"
            >
              💾 Save Current Scenario
            </button>
            <button
              class="btn btn-secondary"
              onclick="document.getElementById('import-file').click()"
            >
              📥 Import Scenarios
            </button>
            <button class="btn btn-secondary" onclick="exportAllScenarios()">
              📤 Export All Scenarios
            </button>
            <input
              type="file"
              id="import-file"
              accept=".json"
              style="display: none"
              onchange="handleScenarioImport(this)"
            />
          </div>
        </div>

        <!-- Scenarios List -->
        <div class="dashboard-section">
          <h3>Saved Scenarios</h3>
          <div id="scenarios-list">
            <div class="no-scenarios">No saved scenarios</div>
          </div>
        </div>

        <!-- Scenario Comparison -->
        <div class="dashboard-section">
          <h3>Scenario Comparison</h3>
          <div id="scenario-comparison">
            <p>Select multiple scenarios to compare their results.</p>
          </div>
        </div>
      </div>

      <div id="comparison" class="tab-content">
        <h2>Strategy Comparison (With Cash Flow Reinvestment)</h2>
        <div class="table-container">
          <table id="comparisonTable">
            <thead>
              <tr>
                <th rowspan="2">Year</th>
                <th rowspan="2">Property<br />Cost</th>
                <th
                  colspan="4"
                  style="
                    background: linear-gradient(45deg, #28a745, #20c997);
                    text-align: center;
                  "
                >
                  Self Financed
                </th>
                <th
                  colspan="6"
                  style="
                    background: linear-gradient(45deg, #667eea, #764ba2);
                    text-align: center;
                  "
                >
                  Bank Financed
                </th>
              </tr>
              <tr>
                <th>New<br />Units</th>
                <th>Total<br />Units</th>
                <th>Closing<br />Cash</th>
                <th>Asset<br />Value</th>
                <th>New<br />Units</th>
                <th>Total<br />Units</th>
                <th>Closing<br />Cash</th>
                <th>Asset<br />Value</th>
                <th>Loan<br />Balance</th>
                <th>Net<br />Equity</th>
              </tr>
            </thead>
            <tbody id="comparisonBody"></tbody>
          </table>
        </div>
      </div>

      <div id="cashflow" class="tab-content">
        <h2>15-Year Cash Flow Analysis</h2>
        <div class="table-container">
          <table id="cashflowTable" class="cashflow-analysis-table">
            <thead>
              <tr>
                <th rowspan="2">Year</th>
                <th
                  colspan="5"
                  style="
                    background: linear-gradient(45deg, #28a745, #20c997);
                    text-align: center;
                  "
                >
                  Self Financed Strategy
                </th>
                <th
                  colspan="7"
                  style="
                    background: linear-gradient(45deg, #667eea, #764ba2);
                    text-align: center;
                  "
                >
                  Bank Financed Strategy
                </th>
              </tr>
              <tr>
                <th>Opening<br />Cash</th>
                <th>Cash<br />Inflows</th>
                <th>Cash<br />Outflows</th>
                <th>Net<br />Cash Flow</th>
                <th>Closing<br />Cash</th>
                <th>Opening<br />Cash</th>
                <th>Cash<br />Inflows</th>
                <th>Cash<br />Outflows</th>
                <th>Net<br />Cash Flow</th>
                <th>Closing<br />Cash</th>
                <th>Opening<br />Loan</th>
                <th>Closing<br />Loan</th>
              </tr>
            </thead>
            <tbody id="cashflowBody"></tbody>
          </table>
        </div>
      </div>

      <div id="sensitivity" class="tab-content">
        <h2>Sensitivity Analysis</h2>
        <p>
          See how changes in key parameters affect your investment outcomes.
          Each parameter is varied by ±10%, ±20%, and ±30% from your base case.
        </p>

        <h3>Net Worth Impact (15-Year)</h3>
        <div class="table-container">
          <table id="sensitivityNetWorthTable">
            <thead>
              <tr>
                <th>Parameter</th>
                <th>-30%</th>
                <th>-20%</th>
                <th>-10%</th>
                <th>Base Case</th>
                <th>+10%</th>
                <th>+20%</th>
                <th>+30%</th>
              </tr>
            </thead>
            <tbody id="sensitivityNetWorthBody"></tbody>
          </table>
        </div>
      </div>

      <div id="breakeven" class="tab-content">
        <h2>Break-Even Analysis</h2>
        <p>
          Understand when your investment becomes profitable and what conditions
          are needed for target returns.
        </p>

        <div class="summary-cards">
          <div class="card">
            <h3>Cash Flow Break-Even</h3>
            <div class="value" id="cashFlowBreakEven">Year 0</div>
            <p>When annual cash flow turns positive</p>
          </div>
          <div class="card">
            <h3>ROI Break-Even</h3>
            <div class="value" id="roiBreakEven">Year 0</div>
            <p>When returns exceed 10% annually</p>
          </div>
        </div>
      </div>

      <!-- ROI Analysis Tab -->
      <div id="roi" class="tab-content">
        <h2>Return on Investment Analysis</h2>
        <p style="margin-bottom: 20px; color: #666">
          Compare real estate returns against alternative investments
        </p>

        <div id="roiCards">
          <!-- ROI cards will be populated by JavaScript -->
        </div>

        <div class="table-container">
          <h3>Investment Comparison</h3>
          <table>
            <thead>
              <tr>
                <th>Investment Type</th>
                <th>Initial Investment</th>
                <th>Final Value</th>
                <th>Total Return</th>
                <th>Annual ROI</th>
                <th>Risk Level</th>
              </tr>
            </thead>
            <tbody id="roiComparisonBody">
              <tr>
                <td colspan="6" style="text-align: center; color: #666">
                  Run calculations to see ROI comparison
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="table-container">
          <h3>Year-by-Year Value Comparison</h3>
          <table>
            <thead>
              <tr>
                <th>Year</th>
                <th>Real Estate (Self)</th>
                <th>Real Estate (Financed)</th>
                <th>S&P 500</th>
                <th>Bonds</th>
                <th>Savings Account</th>
              </tr>
            </thead>
            <tbody id="roiYearlyBody">
              <tr>
                <td colspan="6" style="text-align: center; color: #666">
                  Run calculations to see yearly comparison
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Help Tab -->
      <div id="help" class="tab-content">
        <h2>Help & Documentation</h2>

        <div
          style="
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
          "
        >
          <h3>📖 How to Use This Model</h3>
          <ol style="margin-left: 20px; line-height: 1.8">
            <li>
              <strong>Choose Budget Strategy:</strong> Select "Predetermined
              Annual Budget" for fixed yearly investment or "Needs-Based
              Investment" for dynamic, opportunity-driven investing
            </li>
            <li>
              <strong>Set Investment Objectives:</strong> For needs-based
              strategy, choose your primary goal (maximize cash flow, ROI,
              portfolio size, etc.) and risk tolerance
            </li>
            <li>
              <strong>Configure Parameters:</strong> Set property details,
              financing options, and market assumptions in the Settings tab
            </li>
            <li>
              <strong>Enable AI Enhancement (Optional):</strong> Turn on
              AI-powered market projections for location-specific insights
            </li>
            <li>
              <strong>Calculate:</strong> Click "Calculate Investment Scenarios"
              - the system will automatically return you to your previous tab
            </li>
            <li>
              <strong>Review Results:</strong> Navigate through all analysis
              tabs for comprehensive insights
            </li>
            <li>
              <strong>Save & Compare:</strong> Save scenarios and export results
              to Excel for further analysis
            </li>
          </ol>
        </div>

        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
          "
        >
          <div
            style="
              background: white;
              padding: 20px;
              border-radius: 10px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            "
          >
            <h3>🏠 Investment Strategies</h3>
            <p>
              <strong>Self-Financed:</strong> Purchase properties with 100%
              cash, no debt obligations
            </p>
            <p>
              <strong>Bank-Financed:</strong> Use leverage with customizable LTV
              ratios (default 70%)
            </p>
            <p>
              <strong>Budget Modes:</strong> Choose between predetermined annual
              budget or needs-based dynamic investment
            </p>
            <p>
              <strong>Comparison:</strong> Model compares both financing
              strategies across multiple investment objectives over 15 years
            </p>
          </div>

          <div
            style="
              background: white;
              padding: 20px;
              border-radius: 10px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            "
          >
            <h3>💰 Key Metrics Explained</h3>
            <p><strong>Cash Flow:</strong> Annual income minus expenses</p>
            <p><strong>Net Worth:</strong> Property value + cash - debt</p>
            <p>
              <strong>ROI/ROE:</strong> Annualized return on investment/equity
            </p>
            <p>
              <strong>Leverage Multiplier:</strong> Asset value relative to
              equity invested
            </p>
            <p><strong>Units per $1K:</strong> Investment efficiency metric</p>
            <p>
              <strong>Break-Even:</strong> Year when strategy becomes profitable
            </p>
            <p>
              <strong>Dynamic Score:</strong> Investment opportunity rating for
              needs-based mode
            </p>
          </div>

          <div
            style="
              background: white;
              padding: 20px;
              border-radius: 10px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            "
          >
            <h3>📊 Analysis Tabs</h3>
            <p>
              <strong>📊 Dashboard:</strong> Key performance metrics and
              Investment Strategy Overview
            </p>
            <p>
              <strong>📈 Charts & Analysis:</strong> Visual representations and
              trend analysis
            </p>
            <p>
              <strong>📊 Strategy Comparison:</strong> Side-by-side year-by-year
              comparison
            </p>
            <p>
              <strong>💰 Cash Flow Analysis:</strong> Detailed cash flow
              breakdown with yearly projections
            </p>
            <p>
              <strong>🎯 Sensitivity Analysis:</strong> Tornado diagrams showing
              parameter impact
            </p>
            <p>
              <strong>⚖️ Break-Even Analysis:</strong> Profitability timeline
              and crossover points
            </p>
            <p>
              <strong>📈 ROI Analysis:</strong> Returns vs alternative
              investments with risk assessment
            </p>
            <p>
              <strong>💾 Scenarios:</strong> Save, load, and compare different
              investment scenarios
            </p>
          </div>

          <div
            style="
              background: white;
              padding: 20px;
              border-radius: 10px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            "
          >
            <h3>⚙️ Important Parameters</h3>
            <p>
              <strong>Budget Strategy:</strong> Predetermined annual budget vs
              needs-based dynamic investment
            </p>
            <p>
              <strong>Investment Objective:</strong> Maximize cash flow, ROI,
              portfolio size, or balanced growth
            </p>
            <p>
              <strong>Risk Tolerance:</strong> Conservative, moderate, or
              aggressive investment approach
            </p>
            <p>
              <strong>Rental Rate:</strong> Monthly rent as % of property cost
            </p>
            <p>
              <strong>Interest Rate:</strong> Mortgage interest rate
              (AI-enhanced or manual)
            </p>
            <p><strong>LTV Ratio:</strong> Loan-to-value ratio for financing</p>
            <p>
              <strong>Appreciation Rate:</strong> Annual property value growth
              (AI-enhanced or manual)
            </p>
            <p>
              <strong>Max Investment Limits:</strong> Single investment and
              total investment caps for needs-based mode
            </p>
          </div>
        </div>

        <div
          style="
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #2196f3;
          "
        >
          <h3>💡 Tips for Best Results</h3>
          <ul style="margin-left: 20px; line-height: 1.8">
            <li>
              <strong>Budget Strategy:</strong> Use predetermined budget for
              consistent cash flow planning; use needs-based for
              opportunity-driven investing
            </li>
            <li>
              <strong>Rental Rates:</strong> Use realistic rates (typically
              0.8-1.2% of property value monthly)
            </li>
            <li>
              <strong>AI Enhancement:</strong> Enable AI projections for
              location-specific market insights, or override with your local
              knowledge
            </li>
            <li>
              <strong>Investment Objectives:</strong> Match your selection to
              your actual financial goals and timeline
            </li>
            <li>
              <strong>Sensitivity Analysis:</strong> Use the tornado diagram to
              identify which parameters most impact your returns
            </li>
            <li>
              <strong>Scenario Comparison:</strong> Save multiple scenarios to
              compare different markets, objectives, or parameters
            </li>
            <li>
              Account for property management, maintenance costs, and vacancy
              rates in your expense assumptions
            </li>
            <li>
              Factor in tax implications, depreciation benefits, and local
              regulations
            </li>
            <li>
              Regularly update your assumptions as market conditions change
            </li>
          </ul>
        </div>

        <!-- New AI Enhancement Section -->
        <div
          style="
            background: #e8f5e8;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #4caf50;
          "
        >
          <h3>🤖 AI-Enhanced Analysis</h3>
          <p style="margin-bottom: 15px">
            <strong>Location-Specific Insights:</strong> When enabled, the AI
            system provides:
          </p>
          <ul style="margin-left: 20px; line-height: 1.8">
            <li>
              <strong>Property Appreciation:</strong> Historical trends and
              future projections for your specific market
            </li>
            <li>
              <strong>Rent Growth Analysis:</strong> Local rental market
              dynamics and growth forecasts
            </li>
            <li>
              <strong>Interest Rate Forecasts:</strong> Federal Reserve trends
              and economic indicators
            </li>
            <li>
              <strong>Market Condition Assessment:</strong> Current market
              status (buyer's/seller's market)
            </li>
            <li>
              <strong>Risk & Opportunity Analysis:</strong> Location-specific
              factors affecting investment success
            </li>
          </ul>
          <p style="margin-top: 15px; font-style: italic">
            💡 You can override any AI projection with your own estimates while
            keeping other enhancements active.
          </p>
        </div>

        <!-- Additional Cash Injections Section -->
        <div
          style="
            background: #fff3e0;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #ff9800;
          "
        >
          <h3>🎯 Needs-Based Investment Strategy</h3>
          <p style="margin-bottom: 15px">
            <strong>Dynamic Investment Approach:</strong> When you select
            needs-based investment:
          </p>
          <ul style="margin-left: 20px; line-height: 1.8">
            <li>
              <strong>Opportunity Scoring:</strong> System evaluates each year
              for investment potential based on your objectives
            </li>
            <li>
              <strong>Investment Objectives:</strong> Choose from maximize cash
              flow, ROI, portfolio size, balanced growth, or conservative growth
            </li>
            <li>
              <strong>Risk Management:</strong> Set conservative, moderate, or
              aggressive risk tolerance levels
            </li>
            <li>
              <strong>Investment Limits:</strong> Define maximum single
              investment and total investment caps
            </li>
            <li>
              <strong>Cash Injections Analysis:</strong> View detailed breakdown
              of when and why additional investments are recommended
            </li>
            <li>
              <strong>Dynamic Scoring:</strong> Each investment opportunity gets
              scored against your objectives and thresholds
            </li>
          </ul>
          <p style="margin-top: 15px; font-style: italic">
            💡 This mode is ideal for investors who want to optimize investment
            timing and have flexible capital availability.
          </p>
        </div>
      </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay" style="display: none">
      <div class="loading-backdrop"></div>
      <div class="loading-content">
        <div class="loading-spinner">
          <div class="spinner-ring">
            <div class="spinner-segment"></div>
            <div class="spinner-segment"></div>
            <div class="spinner-segment"></div>
            <div class="spinner-segment"></div>
          </div>
        </div>
        <div class="loading-text">
          <h3>🤖 Calculating Investment Scenarios</h3>
          <p id="loadingSubtext">
            Analyzing market conditions and generating projections...
          </p>
          <div class="loading-progress">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-steps">
              <div class="progress-step active" id="step1">
                📊 Gathering Parameters
              </div>
              <div class="progress-step" id="step2">🤖 AI Market Analysis</div>
              <div class="progress-step" id="step3">
                📈 Calculating Scenarios
              </div>
              <div class="progress-step" id="step4">✅ Generating Results</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Year Detail Modal -->
    <div id="yearModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <button
            class="nav-btn"
            id="prevYearBtn"
            onclick="navigateToYear(utils.currentModalIndex - 1)"
            title="Previous Year"
          >
            &lt;
          </button>
          <div class="modal-title">
            <h2>Year <span id="modalYear"></span> - Detailed Analysis</h2>
          </div>
          <div class="modal-controls">
            <select
              id="strategySelect"
              class="modal-dropdown"
              onchange="switchStrategy(this.value)"
            >
              <option value="self">Self-Financed</option>
              <option value="financed">Bank-Financed</option>
            </select>
            <select
              id="statementSelect"
              class="modal-dropdown"
              onchange="showModalTab(this.value)"
            >
              <option value="pl">P&L Statement</option>
              <option value="balance">Balance Sheet</option>
              <option value="cashflow">Cash Flow</option>
            </select>
            <button
              class="nav-btn"
              id="nextYearBtn"
              onclick="navigateToYear(utils.currentModalIndex + 1)"
              title="Next Year"
            >
              &gt;
            </button>
            <span class="close" onclick="closeModal()">&times;</span>
          </div>
        </div>

        <div class="modal-body">
          <div class="modal-selection-display">
            <span id="selectedStrategy">Self-Financed</span> •
            <span id="selectedStatement">P&L Statement</span>
          </div>

          <div id="plContent" class="modal-tab-content active">
            <table class="pl-table" id="plTable">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody id="plBody"></tbody>
            </table>
          </div>

          <div id="balanceContent" class="modal-tab-content">
            <table class="balance-table" id="balanceTable">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody id="balanceBody"></tbody>
            </table>
          </div>

          <div id="cashflowContent" class="modal-tab-content">
            <table class="cashflow-table" id="modalCashflowTable">
              <thead>
                <tr>
                  <th>Cash Flow Item</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody id="modalCashflowBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript Files -->
    <script src="js/core/utils.js"></script>
    <script src="js/core/data-model.js"></script>
    <script src="js/core/calculations.js"></script>
    <script src="js/components/ui-manager.js"></script>
    <script src="test-modal-debug.js"></script>
    <script src="js/components/export.js"></script>
    <script src="js/components/worker-manager.js"></script>
    <script src="js/modules/roi-analysis.js"></script>
    <script src="js/modules/sensitivity-analysis.js"></script>
    <script src="js/modules/balance-sheet.js"></script>
    <script src="js/modules/ai-market-data.js"></script>
    <script src="js/modules/charts.js"></script>
    <script src="js/modules/scenario-manager.js"></script>
    <script src="js/modules/pdf-export.js"></script>
    <script src="js/app.js"></script>

    <!-- Helper Functions for UI -->
    <script>
      // Scenario import/export helper functions
      function exportAllScenarios() {
        try {
          const exportData = scenarioManager.exportScenarios();
          const blob = new Blob([exportData], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `investment-scenarios-${
            new Date().toISOString().split("T")[0]
          }.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (error) {
          alert("Error exporting scenarios: " + error.message);
        }
      }

      function handleScenarioImport(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const result = scenarioManager.importScenarios(e.target.result, {
              generateNewIds: true,
              renameDuplicates: true,
            });

            let message = `Successfully imported ${result.imported.length} scenarios.`;
            if (result.errors.length > 0) {
              message += `\n${result.errors.length} scenarios failed to import.`;
            }
            alert(message);
          } catch (error) {
            alert("Error importing scenarios: " + error.message);
          }
        };
        reader.readAsText(file);
        input.value = ""; // Reset file input
      }

      // AI Control Functions
      function toggleAIData() {
        const checkbox = document.getElementById("useAIData");
        const settings = document.getElementById("ai-settings");
        const status = document.getElementById("ai-status");

        if (checkbox.checked) {
          settings.style.display = "block";
          status.textContent =
            "AI enabled - Configure location and data sources";
          console.log("🤖 AI market data enabled");
        } else {
          settings.style.display = "none";
          status.textContent = "Static model - Enable AI for real market data";
          console.log("📊 Using static model data");
        }
      }

      async function fetchAIProjections() {
        const useAI = document.getElementById("useAIData").checked;
        if (!useAI) return null;

        const location = {
          city: document.getElementById("city").value.trim(),
          state: document.getElementById("state").value,
          zipCode: document.getElementById("zipCode").value.trim(),
        };

        const propertyType = document.getElementById("propertyType").value;

        if (!location.city || !location.state) {
          alert("Please enter city and state for AI market analysis");
          return null;
        }

        try {
          // Show loading status
          const status = document.getElementById("ai-status");
          const preview = document.getElementById("ai-data-preview");
          status.innerHTML =
            '<div class="ai-loading">Fetching AI market data...</div>';

          // Get financing profile for better interest rate predictions
          const financingProfile = getFinancingProfile();

          // Initialize AI service and get projections
          await window.aiMarketData.initialize(location, propertyType);
          const projections = await window.aiMarketData.getMarketProjections(
            location,
            propertyType,
            15,
            financingProfile
          );

          // Update status
          status.textContent = `AI active - Last updated: ${new Date().toLocaleTimeString()}`;

          // Show preview
          updateAIDataPreview(projections);
          preview.style.display = "block";

          return projections;
        } catch (error) {
          console.error("❌ AI data fetch failed:", error);
          document.getElementById("ai-status").textContent =
            "AI error - Using fallback data";
          return null;
        }
      }

      function updateAIDataPreview(projections) {
        const preview = document.querySelector(".ai-preview-content");
        if (!preview || !projections) return;

        const html = `
          <div><strong>📍 Location:</strong> ${projections.location.city}, ${
          projections.location.state
        }</div>
          <div><strong>🏠 Property Type:</strong> ${
            projections.propertyType
          }</div>
          <div><strong>📈 Avg Property Growth:</strong> ${projections.avgPropertyAppreciation?.toFixed(
            1
          )}%/year</div>
          <div><strong>🏠 Avg Rent Growth:</strong> ${projections.avgRentGrowth?.toFixed(
            1
          )}%/year</div>
          <div><strong>💰 Avg Interest Rate:</strong> ${projections.avgInterestRate?.toFixed(
            2
          )}%</div>
          <div><strong>🎯 Market Conditions:</strong> ${
            projections.marketConditions
          }</div>
          <div><strong>🤖 Confidence:</strong> ${(
            projections.confidence * 100
          ).toFixed(0)}%</div>
        `;
        preview.innerHTML = html;
      }

      // Apply AI projections to calculation parameters
      async function applyAIProjections(params, aiProjections) {
        console.log("🤖 Applying AI projections to parameters...");

        // Create enhanced parameters object
        const enhancedParams = { ...params };

        // Get AI override settings
        const useAIAppreciation =
          document.getElementById("useAIAppreciation").checked;
        const useAIRentGrowth =
          document.getElementById("useAIRentGrowth").checked;
        const useAIInterestRates =
          document.getElementById("useAIInterestRates").checked;

        if (useAIAppreciation && aiProjections.avgPropertyAppreciation) {
          enhancedParams.appreciationRate =
            aiProjections.avgPropertyAppreciation;
          console.log(
            `📈 Using AI property appreciation: ${aiProjections.avgPropertyAppreciation.toFixed(
              1
            )}%`
          );
        }

        if (useAIRentGrowth && aiProjections.avgRentGrowth) {
          enhancedParams.rentGrowthRate = aiProjections.avgRentGrowth;
          console.log(
            `🏠 Using AI rent growth: ${aiProjections.avgRentGrowth.toFixed(
              1
            )}%`
          );
        }

        if (useAIInterestRates && aiProjections.avgInterestRate) {
          enhancedParams.interestRate = aiProjections.avgInterestRate;
          console.log(
            `💰 Using AI interest rate: ${aiProjections.avgInterestRate.toFixed(
              2
            )}%`
          );
        }

        // Add AI metadata to parameters
        enhancedParams.aiData = {
          enabled: true,
          projections: aiProjections,
          lastUpdated: new Date().toISOString(),
          location: aiProjections.location,
          propertyType: aiProjections.propertyType,
        };

        console.log("✅ AI projections applied to parameters");
        return enhancedParams;
      }

      // Initialize enhanced features when page loads
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize worker manager
        workerManager.initWorker();

        // Load scenario list
        scenarioManager.updateScenariosList();

        // Add window resize handler for charts
        window.addEventListener("resize", function () {
          if (window.chartManager) {
            chartManager.resizeCharts();
          }
        });
      });

      // Tab Menu Functions
      function toggleTabMenu() {
        const dropdown = document.getElementById("tabDropdown");
        const toggle = document.querySelector(".tab-menu-toggle");

        if (dropdown.classList.contains("show")) {
          dropdown.classList.remove("show");
          toggle.classList.remove("active");
        } else {
          dropdown.classList.add("show");
          toggle.classList.add("active");
        }
      }

      // Track previous tab for navigation after calculations
      let previousTab = "dashboard"; // Default to dashboard

      // Navigate to previous tab or dashboard after calculations
      function navigateAfterCalculation() {
        // Get the tab names for navigation
        const tabNames = {
          dashboard: "📊 Dashboard",
          charts: "📈 Charts & Analysis",
          scenarios: "💾 Scenarios",
          comparison: "📊 Strategy Comparison",
          cashflow: "💰 Cash Flow Analysis",
          sensitivity: "🎯 Sensitivity Analysis",
          breakeven: "⚖️ Break-Even Analysis",
          roi: "📈 ROI Analysis",
          help: "❓ Help",
        };

        const targetTab = previousTab || "dashboard";
        const tabName = tabNames[targetTab] || "📊 Dashboard";

        // Small delay to ensure all calculations and UI updates are complete
        setTimeout(() => {
          selectTab(targetTab, tabName);
          console.log(`🎯 Navigated back to: ${targetTab}`);
        }, 100);
      }

      function selectTab(tabId, tabName) {
        // Store previous tab when navigating to settings
        const currentActiveTab = document.querySelector(".tab-option.active");
        if (
          currentActiveTab &&
          tabId === "inputs" &&
          currentActiveTab.getAttribute("data-tab") !== "inputs"
        ) {
          previousTab =
            currentActiveTab.getAttribute("data-tab") || "dashboard";
          console.log(`📝 Navigating to settings from: ${previousTab}`);
        }
        // Handle navigation dropdown
        const navDropdown = document.getElementById("nav-dropdown");
        const menuDropdown = document.querySelector(".menu-dropdown");
        if (navDropdown) {
          navDropdown.classList.remove("show");
        }
        if (menuDropdown) {
          menuDropdown.classList.remove("open");
        }

        // Update current tab label for navigation dropdown
        const currentTabLabel = document.querySelector(".current-tab-label");
        if (currentTabLabel) {
          currentTabLabel.textContent = tabName;
        }

        // Update active menu item in navigation dropdown
        document.querySelectorAll(".dropdown-content button").forEach((btn) => {
          btn.classList.remove("active-menu-item");
          if (btn.textContent.includes(tabName)) {
            btn.classList.add("active-menu-item");
          }
        });

        // Handle tab menu dropdown (if it exists)
        const tabDropdown = document.getElementById("tabDropdown");
        const tabToggle = document.querySelector(".tab-menu-toggle");
        if (tabDropdown && tabToggle) {
          tabDropdown.classList.remove("show");
          tabToggle.classList.remove("active");
        }

        // Update current tab name (if element exists)
        const currentTabName = document.querySelector(".current-tab-name");
        if (currentTabName) {
          currentTabName.textContent = tabName;
        }

        // Update active state in tab options
        document.querySelectorAll(".tab-option").forEach((option) => {
          option.classList.remove("active");
        });
        const targetOption = document.querySelector(`[data-tab="${tabId}"]`);
        if (targetOption) {
          targetOption.classList.add("active");
        }

        // Activate the tab
        activateTab(null, tabId);
      }

      // Close dropdown when clicking outside
      document.addEventListener("click", function (event) {
        const menuContainer = document.querySelector(".tab-menu-container");
        if (menuContainer && !menuContainer.contains(event.target)) {
          const dropdown = document.getElementById("tabDropdown");
          const toggle = document.querySelector(".tab-menu-toggle");
          if (dropdown && toggle) {
            dropdown.classList.remove("show");
            toggle.classList.remove("active");
          }
        }
      });

      // Enhanced calculateAll that updates charts after calculation
      async function calculateAll() {
        try {
          // Show loading overlay
          showLoadingOverlay();

          let params = utils.getInputParameters();

          // Fetch AI market projections if enabled
          const aiProjections = await fetchAIProjections();
          if (aiProjections) {
            params = await applyAIProjections(params, aiProjections);
          }

          const validation = dataModel.validateInvestmentParameters(params);

          if (!validation.isValid) {
            alert(
              "Please fix the following errors:\n" +
                validation.errors.join("\n")
            );
            return;
          }

          console.log(
            "🔍 CALCULATE ALL: Using worker manager for calculations"
          );

          // Use worker manager for calculations (which will use worker or fall back to main thread)
          if (
            window.workerManager &&
            typeof workerManager.calculateScenarios === "function"
          ) {
            workerManager.calculateScenarios(params);
          } else {
            console.warn(
              "🔍 WORKER MANAGER NOT AVAILABLE, using direct calculation"
            );
            // Fallback to direct calculation
            const results = calculations.performCalculations(params);

            // Ensure summary metrics are calculated
            if (results && !results.summaryMetrics?.leverageMultiplier) {
              console.log(
                "⚠️ Summary metrics incomplete, manually calling calculateSummaryMetrics..."
              );
              try {
                calculations.calculateSummaryMetrics(results);
                console.log(
                  "✅ Manual calculateSummaryMetrics completed in calculateAll"
                );
              } catch (error) {
                console.error(
                  "❌ calculateSummaryMetrics failed in calculateAll:",
                  error
                );
              }
            }

            utils.calculationResults = results;

            if (typeof updateAllTables === "function") {
              updateAllTables();
            }

            // Navigate back to previous tab after calculations complete
            navigateAfterCalculation();

            // Hide loading overlay
            hideLoadingOverlay();
          }
        } catch (error) {
          console.error("Calculation error:", error);
          if (typeof utils.handleError === "function") {
            utils.handleError(error, "calculateAll");
          }
          alert(
            "An error occurred during calculations. Please check the console for details."
          );

          // Hide loading overlay even on error
          hideLoadingOverlay();
        }
      }

      // Navigation dropdown functions
      function toggleNavMenu() {
        const dropdown = document.getElementById("nav-dropdown");
        const menuDropdown = document.querySelector(".menu-dropdown");

        if (dropdown.classList.contains("show")) {
          dropdown.classList.remove("show");
          menuDropdown.classList.remove("open");
        } else {
          dropdown.classList.add("show");
          menuDropdown.classList.add("open");
        }
      }

      function activateTab(btn, tabName) {
        // Hide all tab contents
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });

        // Show selected tab
        const tabElement = document.getElementById(tabName);
        if (tabElement) {
          tabElement.classList.add("active");
        }
      }

      // Auto-location detection function
      async function detectUserLocation() {
        try {
          // Try geolocation API first
          if (navigator.geolocation) {
            return new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(
                async (position) => {
                  try {
                    // Use a reverse geocoding service (you'd need an API key for production)
                    // For now, we'll use a fallback approach
                    resolve(await getLocationFromIP());
                  } catch (error) {
                    resolve(await getLocationFromIP());
                  }
                },
                () => {
                  // Geolocation failed, fall back to IP-based detection
                  resolve(getLocationFromIP());
                }
              );
            });
          } else {
            return await getLocationFromIP();
          }
        } catch (error) {
          console.warn("Location detection failed:", error);
          return { city: "Austin", state: "Texas" }; // Default fallback
        }
      }

      async function getLocationFromIP() {
        try {
          // Using a free IP geolocation service
          const response = await fetch("https://ipapi.co/json/", {
            timeout: 3000,
          });
          const data = await response.json();

          return {
            city: data.city || "Austin",
            state: data.region || "Texas",
          };
        } catch (error) {
          console.warn("IP-based location detection failed:", error);
          // Return default location
          return { city: "Austin", state: "Texas" };
        }
      }

      // Initialize app on page load
      window.addEventListener("DOMContentLoaded", async function () {
        console.log("🚀 Initializing Investment Model...");

        try {
          // Auto-detect location and populate AI fields
          const location = await detectUserLocation();
          console.log("📍 Detected location:", location);

          // Populate AI location fields
          const cityInput = document.getElementById("city");
          const stateSelect = document.getElementById("state");

          if (cityInput) cityInput.value = location.city;
          if (stateSelect) {
            // Try to match state name to select options
            const stateOptions = stateSelect.options;
            for (let i = 0; i < stateOptions.length; i++) {
              if (
                stateOptions[i].value === location.state ||
                stateOptions[i].text.includes(location.state)
              ) {
                stateSelect.selectedIndex = i;
                break;
              }
            }
          }

          // Enable AI data if location detected successfully
          if (location.city && location.state) {
            const useAICheckbox = document.getElementById("useAIData");
            if (useAICheckbox && !useAICheckbox.checked) {
              useAICheckbox.checked = true;
              if (typeof toggleAIData === "function") {
                toggleAIData();
              }
            }

            // Show location subtitle
            updateLocationSubtitle(location);
          }

          // Auto-calculate after a short delay to let everything initialize
          setTimeout(async () => {
            console.log("🔄 Running initial calculations...");
            await calculateAll();

            // Navigate to dashboard tab for better UX
            selectTab("dashboard", "📊 Dashboard");
            console.log("✅ App initialization complete");
          }, 1000);
        } catch (error) {
          console.error("❌ App initialization error:", error);
          // Still run calculations even if location detection fails
          setTimeout(async () => {
            await calculateAll();
            selectTab("dashboard", "📊 Dashboard");
          }, 1000);
        }
      });

      // Update location subtitle with AI settings information
      function updateLocationSubtitle(location) {
        const subtitle = document.getElementById("app-subtitle");
        const locationText = document.getElementById("location-text");
        const useAICheckbox = document.getElementById("useAIData");

        if (
          useAICheckbox &&
          useAICheckbox.checked &&
          location &&
          location.city &&
          location.state
        ) {
          if (locationText) {
            // Get which AI data sources are enabled
            const aiSources = getEnabledAISources();
            const sourcesText =
              aiSources.length > 0 ? ` • AI: ${aiSources.join(", ")}` : "";
            locationText.textContent = `${location.city}, ${location.state} Market Analysis${sourcesText}`;
          }
          if (subtitle) {
            subtitle.style.display = "flex";
          }
        } else {
          if (subtitle) {
            subtitle.style.display = "none";
          }
        }
      }

      // Get enabled AI data sources
      function getEnabledAISources() {
        const sources = [];

        if (document.getElementById("useAIAppreciation")?.checked) {
          sources.push("Property Prices");
        }
        if (document.getElementById("useAIRentGrowth")?.checked) {
          sources.push("Rent Growth");
        }
        if (document.getElementById("useAIInterestRates")?.checked) {
          sources.push("Interest Rates");
        }
        if (document.getElementById("useAIMarketInsights")?.checked) {
          sources.push("Market Insights");
        }

        return sources;
      }

      // Function to handle AI toggle (needs to be globally accessible)
      window.toggleAIDataAndSubtitle = function () {
        // Call original toggleAIData if it exists
        if (typeof toggleAIData === "function") {
          toggleAIData();
        }

        // Update subtitle based on AI state and current location
        const cityInput = document.getElementById("city");
        const stateSelect = document.getElementById("state");
        const location = {
          city: cityInput ? cityInput.value : "",
          state: stateSelect ? stateSelect.value : "",
        };

        updateLocationSubtitle(location);
      };

      // Add event listeners to location inputs and AI checkboxes to update subtitle
      document.addEventListener("DOMContentLoaded", function () {
        const cityInput = document.getElementById("city");
        const stateSelect = document.getElementById("state");

        function updateSubtitleFromInputs() {
          const location = {
            city: cityInput ? cityInput.value : "",
            state: stateSelect ? stateSelect.value : "",
          };
          updateLocationSubtitle(location);
        }

        if (cityInput) {
          cityInput.addEventListener("input", updateSubtitleFromInputs);
        }

        if (stateSelect) {
          stateSelect.addEventListener("change", updateSubtitleFromInputs);
        }

        // Add listeners to AI data source checkboxes with override functionality
        setupAIOverrideControls();

        const aiCheckboxes = [
          "useAIAppreciation",
          "useAIRentGrowth",
          "useAIInterestRates",
          "useAIMarketInsights",
        ];

        aiCheckboxes.forEach((checkboxId) => {
          const checkbox = document.getElementById(checkboxId);
          if (checkbox) {
            checkbox.addEventListener("change", updateSubtitleFromInputs);
          }
        });
      });

      // Setup AI override controls
      function setupAIOverrideControls() {
        const overrideControls = [
          {
            checkbox: "useAIAppreciation",
            overrideContainer: "appreciationOverride",
            overrideInput: "overrideAppreciation",
          },
          {
            checkbox: "useAIRentGrowth",
            overrideContainer: "rentGrowthOverride",
            overrideInput: "overrideRentGrowth",
          },
          {
            checkbox: "useAIInterestRates",
            overrideContainer: "interestRateOverride",
            overrideInput: "overrideInterestRate",
          },
        ];

        overrideControls.forEach((control) => {
          const checkbox = document.getElementById(control.checkbox);
          const container = document.getElementById(control.overrideContainer);

          if (checkbox && container) {
            checkbox.addEventListener("change", function () {
              if (checkbox.checked) {
                // AI enabled - hide override input
                container.style.display = "none";
              } else {
                // AI disabled - show override input
                container.style.display = "flex";

                // Focus on the input for immediate user entry
                const input = document.getElementById(control.overrideInput);
                if (input) {
                  setTimeout(() => input.focus(), 100);
                }
              }

              // Update subtitle to reflect changes
              updateSubtitleFromInputs();
            });
          }
        });
      }

      // Get user override values for calculations
      window.getAIOverrides = function () {
        const overrides = {};

        // Property appreciation override
        const useAppreciation =
          document.getElementById("useAIAppreciation")?.checked;
        if (!useAppreciation) {
          const override = document.getElementById(
            "overrideAppreciation"
          )?.value;
          if (override && !isNaN(parseFloat(override))) {
            overrides.appreciationRate = parseFloat(override);
          }
        }

        // Rent growth override
        const useRentGrowth =
          document.getElementById("useAIRentGrowth")?.checked;
        if (!useRentGrowth) {
          const override = document.getElementById("overrideRentGrowth")?.value;
          if (override && !isNaN(parseFloat(override))) {
            overrides.rentGrowthRate = parseFloat(override);
          }
        }

        // Interest rate override
        const useInterestRates =
          document.getElementById("useAIInterestRates")?.checked;
        if (!useInterestRates) {
          const override = document.getElementById(
            "overrideInterestRate"
          )?.value;
          if (override && !isNaN(parseFloat(override))) {
            overrides.interestRate = parseFloat(override);
          }
        }

        return overrides;
      };

      // Budget Mode Functions
      function toggleBudgetMode() {
        const predeterminedRadio = document.querySelector(
          'input[name="budgetMode"][value="predetermined"]'
        );
        const needsBasedRadio = document.querySelector(
          'input[name="budgetMode"][value="needsBased"]'
        );
        const predeterminedControls = document.getElementById(
          "predeterminedBudgetControls"
        );
        const needsBasedControls =
          document.getElementById("needsBasedControls");

        if (predeterminedRadio.checked) {
          predeterminedControls.style.display = "block";
          needsBasedControls.style.display = "none";
          console.log("💰 Switched to predetermined budget mode");

          // Hide cash injections sections
          const cashInjectionsSection = document.getElementById(
            "cash-injections-section"
          );
          const cashInjectionsChart = document.getElementById(
            "cash-injections-chart-container"
          );
          if (cashInjectionsSection)
            cashInjectionsSection.style.display = "none";
          if (cashInjectionsChart) cashInjectionsChart.style.display = "none";
        } else if (needsBasedRadio.checked) {
          predeterminedControls.style.display = "none";
          needsBasedControls.style.display = "block";
          console.log("🎯 Switched to needs-based investment mode");

          // Show cash injections sections (they will be populated on next calculation)
          const cashInjectionsSection = document.getElementById(
            "cash-injections-section"
          );
          const cashInjectionsChart = document.getElementById(
            "cash-injections-chart-container"
          );
          if (cashInjectionsSection)
            cashInjectionsSection.style.display = "block";
          if (cashInjectionsChart) cashInjectionsChart.style.display = "block";
        }

        // Update the Investment Strategy Overview immediately if results exist
        if (
          utils.calculationResults &&
          window.balanceSheet &&
          typeof balanceSheet.updateModelSynopsis === "function"
        ) {
          balanceSheet.updateModelSynopsis();
          console.log(
            "📊 Updated Investment Strategy Overview for new budget mode"
          );
        }
      }

      function getBudgetMode() {
        const budgetModeRadio = document.querySelector(
          'input[name="budgetMode"]:checked'
        );
        return budgetModeRadio ? budgetModeRadio.value : "predetermined";
      }

      function getBudgetSettings() {
        const budgetMode = getBudgetMode();

        if (budgetMode === "predetermined") {
          return {
            mode: "predetermined",
            annualBudget:
              parseFloat(document.getElementById("annualBudget").value) ||
              170000,
          };
        } else {
          return {
            mode: "needsBased",
            investmentObjective:
              document.getElementById("investmentObjective").value ||
              "balanced",
            maxSingleInvestment:
              parseFloat(
                document.getElementById("maxSingleInvestment").value
              ) || 500000,
            totalInvestmentLimit:
              parseFloat(
                document.getElementById("totalInvestmentLimit").value
              ) || 2000000,
            minROIThreshold:
              parseFloat(document.getElementById("minROIThreshold").value) || 8,
            targetAnnualCashFlow:
              parseFloat(
                document.getElementById("targetAnnualCashFlow").value
              ) || 50000,
            riskTolerance:
              document.getElementById("riskTolerance").value || "moderate",
          };
        }
      }

      function calculateAdditionalCashInjections(data) {
        const budgetSettings = getBudgetSettings();
        const injections = [];

        if (budgetSettings.mode === "needsBased") {
          let totalInvested = 0;
          let totalCashFlow = 0;
          const selfPurchaseYears =
            parseInt(document.getElementById("selfPurchaseYears").value) || 3;
          const objective = budgetSettings.investmentObjective || "balanced";

          // Get objective description for reasons
          const objectiveDescriptions = {
            maxCashFlow: "maximizes cash flow generation",
            maxTotalReturn: "optimizes total return (cash flow + appreciation)",
            maxROI: "achieves highest capital efficiency",
            maxPortfolioSize: "maximizes property acquisition",
            balanced: "provides balanced growth and income",
            conservative: "offers stable, low-risk returns",
          };

          for (let year = 1; year <= selfPurchaseYears; year++) {
            const yearData = data.find((d) => d.year === year);
            if (!yearData) continue;

            // Calculate comprehensive investment metrics
            const projectedROI =
              (yearData.netCashFlow / yearData.totalInvestment) * 100;
            const yearCashFlow = yearData.netCashFlow || 0;

            // Check various thresholds based on objective
            let shouldInvest = false;
            let investmentReason = "";
            let adjustedThreshold = budgetSettings.minROIThreshold;

            switch (objective) {
              case "maxCashFlow":
                shouldInvest =
                  yearCashFlow > 0 && projectedROI >= adjustedThreshold - 1;
                investmentReason = `Strong cash flow potential ($${yearCashFlow.toLocaleString()}/year)`;
                if (totalCashFlow >= budgetSettings.targetAnnualCashFlow)
                  shouldInvest = false;
                break;

              case "maxTotalReturn":
                const totalReturn = projectedROI + 3; // Assume 3% appreciation
                shouldInvest = totalReturn >= adjustedThreshold;
                investmentReason = `Excellent total return potential (${totalReturn.toFixed(
                  1
                )}% combined)`;
                break;

              case "maxROI":
                adjustedThreshold = budgetSettings.minROIThreshold + 1;
                shouldInvest = projectedROI >= adjustedThreshold;
                investmentReason = `High ROI efficiency (${projectedROI.toFixed(
                  1
                )}%)`;
                break;

              case "maxPortfolioSize":
                adjustedThreshold = Math.max(
                  3,
                  budgetSettings.minROIThreshold - 2
                );
                shouldInvest = projectedROI >= adjustedThreshold;
                investmentReason = `Portfolio expansion opportunity (${projectedROI.toFixed(
                  1
                )}% ROI)`;
                break;

              case "conservative":
                adjustedThreshold = budgetSettings.minROIThreshold + 2;
                shouldInvest =
                  projectedROI >= adjustedThreshold && projectedROI <= 15;
                investmentReason = `Stable, conservative investment (${projectedROI.toFixed(
                  1
                )}% ROI)`;
                break;

              case "balanced":
              default:
                shouldInvest = projectedROI >= adjustedThreshold;
                investmentReason = `Balanced investment opportunity (${projectedROI.toFixed(
                  1
                )}% ROI)`;
                break;
            }

            if (
              shouldInvest &&
              totalInvested < budgetSettings.totalInvestmentLimit
            ) {
              let optimalInvestment = Math.min(
                budgetSettings.maxSingleInvestment,
                budgetSettings.totalInvestmentLimit - totalInvested,
                yearData.totalInvestment || 0
              );

              // Adjust investment size based on objective
              if (objective === "maxPortfolioSize") {
                // Prefer smaller investments to maximize unit count
                optimalInvestment = Math.min(
                  optimalInvestment,
                  yearData.totalInvestment * 0.3
                );
              } else if (objective === "maxCashFlow") {
                // Adjust based on cash flow potential
                const cashFlowMultiplier = Math.min(2.0, yearCashFlow / 20000);
                optimalInvestment = Math.min(
                  optimalInvestment,
                  optimalInvestment * cashFlowMultiplier
                );
              }

              if (optimalInvestment > 0) {
                injections.push({
                  year: year,
                  amount: optimalInvestment,
                  projectedROI: projectedROI.toFixed(1),
                  reason: investmentReason,
                  objective:
                    objectiveDescriptions[objective] || "strategic investment",
                  expectedCashFlow: yearCashFlow,
                });
                totalInvested += optimalInvestment;
                totalCashFlow += yearCashFlow;
              }
            }
          }
        }

        return injections;
      }

      function calculateROIComparison(data, budgetSettings, injections) {
        const annualBudget =
          parseFloat(document.getElementById("annualBudget").value) || 170000;
        const selfPurchaseYears =
          parseInt(document.getElementById("selfPurchaseYears").value) || 3;

        // Calculate predetermined budget scenario
        const predeterminedTotalInvestment = annualBudget * selfPurchaseYears;

        // Calculate predetermined ROI more safely
        let predeterminedAverageROI = 0;
        if (data.length > 0) {
          let validROIEntries = 0;
          let totalROI = 0;

          data.forEach((year) => {
            if (
              year.netCashFlow &&
              year.totalInvestment &&
              year.totalInvestment > 0
            ) {
              const yearROI = (year.netCashFlow / year.totalInvestment) * 100;
              if (!isNaN(yearROI) && isFinite(yearROI)) {
                totalROI += yearROI;
                validROIEntries++;
              }
            }
          });

          if (validROIEntries > 0) {
            predeterminedAverageROI = totalROI / validROIEntries;
          } else {
            // Fallback: estimate ROI based on typical rental property metrics
            const initialCost =
              parseFloat(document.getElementById("initialCost").value) ||
              160000;
            const rentalRate =
              parseFloat(document.getElementById("rentalRate").value) || 1.9;
            const annualRent = initialCost * (rentalRate / 100) * 12;
            const estimatedNOI = annualRent * 0.7; // Assume 30% expenses
            predeterminedAverageROI = (estimatedNOI / initialCost) * 100;
          }
        }

        // Calculate needs-based scenario
        const needsBasedTotalInvestment = injections.reduce(
          (sum, inj) => sum + inj.amount,
          0
        );
        const needsBasedAverageROI =
          injections.length > 0
            ? injections.reduce(
                (sum, inj) => sum + parseFloat(inj.projectedROI),
                0
              ) / injections.length
            : 0;

        // Calculate 15-year projections with compound growth
        const predeterminedNetWorth =
          predeterminedTotalInvestment *
          Math.pow(1 + predeterminedAverageROI / 100, selfPurchaseYears);
        const needsBasedNetWorth =
          needsBasedTotalInvestment *
          Math.pow(1 + needsBasedAverageROI / 100, selfPurchaseYears);

        // Add safety checks for NaN values
        const safePredeterminedAverageROI = isNaN(predeterminedAverageROI)
          ? 0
          : predeterminedAverageROI;
        const safeNeedsBasedAverageROI = isNaN(needsBasedAverageROI)
          ? 0
          : needsBasedAverageROI;
        const safePredeterminedNetWorth = isNaN(predeterminedNetWorth)
          ? predeterminedTotalInvestment
          : predeterminedNetWorth;
        const safeNeedsBasedNetWorth = isNaN(needsBasedNetWorth)
          ? needsBasedTotalInvestment
          : needsBasedNetWorth;

        const advantage = safeNeedsBasedNetWorth - safePredeterminedNetWorth;
        const advantagePercent =
          safePredeterminedNetWorth > 0
            ? (advantage / safePredeterminedNetWorth) * 100
            : 0;

        // Determine which strategy is better
        const betterStrategy =
          safeNeedsBasedNetWorth > safePredeterminedNetWorth
            ? "needs-based"
            : "predetermined";
        const efficiency =
          safeNeedsBasedAverageROI > 0 && safePredeterminedAverageROI > 0
            ? safeNeedsBasedAverageROI / safePredeterminedAverageROI
            : 1;

        // Debug logging
        console.log("🔍 ROI Comparison Debug:", {
          predeterminedTotalInvestment,
          predeterminedAverageROI: safePredeterminedAverageROI,
          predeterminedNetWorth: safePredeterminedNetWorth,
          needsBasedTotalInvestment,
          needsBasedAverageROI: safeNeedsBasedAverageROI,
          needsBasedNetWorth: safeNeedsBasedNetWorth,
          dataLength: data.length,
          injectionsLength: injections.length,
        });

        let html = "";

        if (injections.length === 0) {
          html = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div>
                <strong>Predetermined Budget:</strong><br>
                • Total Investment: $${predeterminedTotalInvestment.toLocaleString()}<br>
                • Average ROI: ${safePredeterminedAverageROI.toFixed(1)}%<br>
                • Strategy: Consistent annual investment
              </div>
              <div>
                <strong>Needs-Based Analysis:</strong><br>
                • No opportunities meet ROI threshold<br>
                • Consider lowering threshold from ${
                  budgetSettings.minROIThreshold
                }%<br>
                • <em style="color: #dc2626;">Predetermined strategy recommended</em>
              </div>
            </div>
          `;
        } else {
          html = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div>
                <strong>Predetermined Budget:</strong><br>
                • Total Investment: $${predeterminedTotalInvestment.toLocaleString()}<br>
                • Average ROI: ${safePredeterminedAverageROI.toFixed(1)}%<br>
                • Projected Value: $${safePredeterminedNetWorth.toLocaleString()}
              </div>
              <div>
                <strong>Needs-Based Strategy:</strong><br>
                • Total Investment: $${needsBasedTotalInvestment.toLocaleString()}<br>
                • Average ROI: ${safeNeedsBasedAverageROI.toFixed(1)}%<br>
                • Projected Value: $${safeNeedsBasedNetWorth.toLocaleString()}
              </div>
            </div>
            <div style="margin-top: 12px; padding: 10px; background: ${
              betterStrategy === "needs-based"
                ? "rgba(22, 163, 74, 0.1)"
                : "rgba(245, 158, 11, 0.1)"
            }; border-radius: 6px;">
              <strong style="color: ${
                betterStrategy === "needs-based" ? "#16a34a" : "#f59e0b"
              };">
                ${
                  betterStrategy === "needs-based"
                    ? "✅ Needs-Based Strategy Recommended"
                    : "⚠️ Predetermined Strategy May Be Better"
                }
              </strong><br>
              ${
                advantage > 0
                  ? `Net advantage: $${Math.abs(
                      advantage
                    ).toLocaleString()} (${Math.abs(advantagePercent).toFixed(
                      1
                    )}% better)`
                  : `Net disadvantage: $${Math.abs(
                      advantage
                    ).toLocaleString()} (${Math.abs(advantagePercent).toFixed(
                      1
                    )}% worse)`
              }<br>
              ROI efficiency: ${efficiency.toFixed(2)}x ${
            efficiency > 1 ? "better" : "worse"
          } than predetermined budget
            </div>
          `;
        }

        return {
          predeterminedTotalInvestment,
          predeterminedAverageROI: safePredeterminedAverageROI,
          needsBasedTotalInvestment,
          needsBasedAverageROI: safeNeedsBasedAverageROI,
          advantage,
          advantagePercent,
          betterStrategy,
          efficiency,
          html,
        };
      }

      function updateCashInjectionsDisplay(data) {
        const budgetMode = getBudgetMode();
        const cashInjectionsSection = document.getElementById(
          "cash-injections-section"
        );

        if (budgetMode === "needsBased") {
          const injections = calculateAdditionalCashInjections(data);
          const tbody = document.getElementById("cash-injections-tbody");
          const strategySummary = document.getElementById(
            "investment-strategy-summary"
          );

          // Show the section
          cashInjectionsSection.style.display = "block";

          // Clear existing rows
          tbody.innerHTML = "";

          if (injections.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5" style="text-align: center; font-style: italic; color: #666;">No additional cash injections required based on current ROI thresholds</td></tr>';
            strategySummary.innerHTML =
              "<p>Current settings do not require additional cash injections. Consider lowering ROI threshold or increasing investment limits to identify opportunities.</p>";
          } else {
            let cumulativeInvestment = 0;
            let totalInjections = 0;
            let totalROI = 0;

            injections.forEach((injection) => {
              cumulativeInvestment += injection.amount;
              totalInjections += injection.amount;
              totalROI += parseFloat(injection.projectedROI);

              const row = document.createElement("tr");
              row.innerHTML = `
                <td>Year ${injection.year}</td>
                <td style="color: #dc2626; font-weight: 600;">$${injection.amount.toLocaleString()}</td>
                <td style="color: #16a34a; font-weight: 600;">${
                  injection.projectedROI
                }%</td>
                <td>$${cumulativeInvestment.toLocaleString()}</td>
                <td style="text-align: left; font-size: 10px;">
                  <div style="font-weight: 600;">${injection.reason}</div>
                  <div style="color: #6b7280; font-size: 9px; margin-top: 2px;">${
                    injection.objective
                  }</div>
                </td>
              `;
              tbody.appendChild(row);
            });

            // Update summary
            document.getElementById(
              "total-cash-injections"
            ).textContent = `$${totalInjections.toLocaleString()}`;
            document.getElementById("avg-projected-roi").textContent = `${(
              totalROI / injections.length
            ).toFixed(1)}%`;
            document.getElementById(
              "final-cumulative-investment"
            ).textContent = `$${cumulativeInvestment.toLocaleString()}`;

            // Update strategy summary
            const budgetSettings = getBudgetSettings();
            // Calculate enhanced ROI comparison
            const roiComparison = calculateROIComparison(
              data,
              budgetSettings,
              injections
            );

            // Get objective description
            const objectiveLabels = {
              maxCashFlow: "🏠 Maximize Cash Flow",
              maxTotalReturn: "📈 Maximize Total Return",
              maxROI: "⚡ Maximize ROI",
              maxPortfolioSize: "🏘️ Maximize Portfolio Size",
              balanced: "⚖️ Balanced Growth",
              conservative: "🛡️ Conservative Growth",
            };

            strategySummary.innerHTML = `
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                  <strong>Investment Strategy:</strong><br>
                  • Objective: ${
                    objectiveLabels[budgetSettings.investmentObjective] ||
                    budgetSettings.investmentObjective
                  }<br>
                  • Risk Tolerance: ${
                    budgetSettings.riskTolerance.charAt(0).toUpperCase() +
                    budgetSettings.riskTolerance.slice(1)
                  }<br>
                  • Target Cash Flow: $${budgetSettings.targetAnnualCashFlow.toLocaleString()}/year<br>
                  • Min ROI Threshold: ${budgetSettings.minROIThreshold}%
                </div>
                <div>
                  <strong>Investment Limits:</strong><br>
                  • Max Single Investment: $${budgetSettings.maxSingleInvestment.toLocaleString()}<br>
                  • Total Investment Limit: $${budgetSettings.totalInvestmentLimit.toLocaleString()}<br>
                  • ${injections.length} strategic injection${
              injections.length > 1 ? "s" : ""
            } identified<br>
                  • Average projected ROI: ${(
                    totalROI / injections.length
                  ).toFixed(1)}%
                </div>
              </div>
              <div style="margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px; border-left: 4px solid #0ea5e9;">
                <h5 style="margin: 0 0 10px 0; color: #0369a1;">📊 ${
                  objectiveLabels[budgetSettings.investmentObjective]
                } Strategy Comparison</h5>
                ${roiComparison.html}
              </div>
            `;
          }
        } else {
          // Hide the section for predetermined budget mode
          cashInjectionsSection.style.display = "none";
        }
      }

      // Financing profile functions
      function updateFinanceSourceDescription() {
        const bankRadio = document.querySelector(
          'input[name="financeSource"][value="bank"]'
        );
        const description = document.getElementById("financeSourceDescription");

        if (bankRadio && bankRadio.checked) {
          description.textContent =
            "Lower rates, stricter requirements, longer processing";
        } else {
          description.textContent =
            "Higher rates, flexible requirements, faster processing";
        }
      }

      function updateCreditScoreDisplay() {
        const slider = document.getElementById("creditScore");
        const badge = document.getElementById("creditScoreBadge");
        const impact = document.getElementById("creditImpact");

        if (!slider || !badge || !impact) {
          console.log("Credit score elements not found:", {
            slider: !!slider,
            badge: !!badge,
            impact: !!impact,
          });
          return;
        }

        console.log("Updating credit score display:", slider.value);

        const scoreRanges = {
          0: {
            badge: "Poor Credit",
            impact:
              "Expect higher rates and stricter down payment requirements",
            badgeColor: "#f44336",
          },
          1: {
            badge: "Fair Credit",
            impact:
              "Moderate rates available with standard qualification terms",
            badgeColor: "#ff9800",
          },
          2: {
            badge: "Good Credit",
            impact:
              "Expect competitive rates with good qualification requirements",
            badgeColor: "#4caf50",
          },
          3: {
            badge: "Excellent Credit",
            impact: "Access to best rates with favorable terms and conditions",
            badgeColor: "#2196f3",
          },
        };

        const currentScore = slider.value;
        const scoreData = scoreRanges[currentScore];

        // Update badge and impact
        badge.textContent = scoreData.badge;
        impact.textContent = scoreData.impact;

        // Update badge color
        badge.style.background = `rgba(${
          scoreData.badgeColor === "#f44336"
            ? "244, 67, 54"
            : scoreData.badgeColor === "#ff9800"
            ? "255, 152, 0"
            : scoreData.badgeColor === "#4caf50"
            ? "76, 175, 80"
            : "33, 150, 243"
        }, 0.2)`;
        badge.style.color = scoreData.badgeColor;
        badge.style.borderColor = `${scoreData.badgeColor}40`;

        // Update feedback border
        const feedback = badge.closest(".slider-feedback");
        if (feedback) {
          feedback.style.borderLeftColor = scoreData.badgeColor;
        }

        // Update active option
        document.querySelectorAll(".slider-option").forEach((option) => {
          option.classList.remove("active");
          if (option.dataset.value === currentScore) {
            option.classList.add("active");
          }
        });

        // Update slider color dynamically
        slider.setAttribute("value", currentScore);
      }

      function updateFinancingTypeDisplay() {
        const slider = document.getElementById("financingType");
        const badge = document.getElementById("financingTypeBadge");
        const impact = document.getElementById("financingTypeImpact");

        if (!slider || !badge || !impact) {
          console.log("Financing type elements not found:", {
            slider: !!slider,
            badge: !!badge,
            impact: !!impact,
          });
          return;
        }

        console.log("Updating financing type display:", slider.value);

        const financingTypes = {
          0: {
            badge: "Traditional Mortgage",
            impact:
              "Lower rates with structured payments and amortization schedule",
            badgeColor: "#4caf50",
          },
          1: {
            badge: "Credit Line",
            impact:
              "Higher variable rates but flexible draw and payment options",
            badgeColor: "#ff9800",
          },
        };

        const currentType = slider.value;
        const typeData = financingTypes[currentType];

        // Update badge and impact
        badge.textContent = typeData.badge;
        impact.textContent = typeData.impact;

        // Update badge color
        badge.style.background = `rgba(${
          typeData.badgeColor === "#4caf50" ? "76, 175, 80" : "255, 152, 0"
        }, 0.2)`;
        badge.style.color = typeData.badgeColor;
        badge.style.borderColor = `${typeData.badgeColor}40`;

        // Update feedback border
        const feedback = badge.closest(".slider-feedback");
        if (feedback) {
          feedback.style.borderLeftColor = typeData.badgeColor;
        }

        // Update active option in financing options
        document
          .querySelectorAll(".financing-options .slider-option")
          .forEach((option) => {
            option.classList.remove("active");
            if (option.dataset.value === currentType) {
              option.classList.add("active");
            }
          });

        // Update slider color dynamically
        slider.setAttribute("value", currentType);
      }

      function getFinancingProfile() {
        const financeSource =
          document.querySelector('input[name="financeSource"]:checked')
            ?.value || "bank";
        const creditScoreSlider = parseInt(
          document.getElementById("creditScore")?.value || "2"
        );
        const financingTypeSlider = parseInt(
          document.getElementById("financingType")?.value || "0"
        );

        // Map slider values back to original 1-4 and 1-2 ranges for AI calculations
        const creditScore = creditScoreSlider + 1; // 0-3 becomes 1-4
        const financingType = financingTypeSlider + 1; // 0-1 becomes 1-2

        return {
          financeSource: financeSource,
          creditScore: creditScore, // 1 = poor, 2 = fair, 3 = good, 4 = excellent
          financingType: financingType, // 1 = mortgage, 2 = credit line
        };
      }

      // Loading overlay functions
      function showLoadingOverlay() {
        const overlay = document.getElementById("loadingOverlay");
        const progressFill = document.getElementById("progressFill");
        const loadingSubtext = document.getElementById("loadingSubtext");

        if (!overlay) return;

        // Reset progress
        progressFill.style.width = "0%";

        // Show overlay
        overlay.style.display = "flex";

        // Disable tab navigation
        const tabOptions = document.querySelectorAll(".tab-option");
        tabOptions.forEach((tab) => {
          tab.style.pointerEvents = "none";
          tab.style.opacity = "0.5";
        });

        // Start progress animation
        animateLoadingProgress();
      }

      function hideLoadingOverlay() {
        const overlay = document.getElementById("loadingOverlay");
        if (!overlay) return;

        // Re-enable tab navigation
        const tabOptions = document.querySelectorAll(".tab-option");
        tabOptions.forEach((tab) => {
          tab.style.pointerEvents = "auto";
          tab.style.opacity = "1";
        });

        // Hide overlay with fade effect
        overlay.style.opacity = "0";
        setTimeout(() => {
          overlay.style.display = "none";
          overlay.style.opacity = "1";
        }, 300);
      }

      function animateLoadingProgress() {
        const progressFill = document.getElementById("progressFill");
        const loadingSubtext = document.getElementById("loadingSubtext");
        const steps = ["step1", "step2", "step3", "step4"];
        const subtexts = [
          "Gathering investment parameters and preferences...",
          "Analyzing market conditions with AI models...",
          "Running financial projections and scenarios...",
          "Generating comprehensive analysis reports...",
        ];

        let currentStep = 0;

        const updateProgress = () => {
          if (currentStep < steps.length) {
            // Update progress bar
            const progress = ((currentStep + 1) / steps.length) * 100;
            progressFill.style.width = progress + "%";

            // Update subtext
            if (loadingSubtext) {
              loadingSubtext.textContent = subtexts[currentStep];
            }

            // Mark current step as active, previous as completed
            steps.forEach((stepId, index) => {
              const stepElement = document.getElementById(stepId);
              if (!stepElement) return;

              stepElement.classList.remove("active", "completed");

              if (index < currentStep) {
                stepElement.classList.add("completed");
              } else if (index === currentStep) {
                stepElement.classList.add("active");
              }
            });

            currentStep++;
          }
        };

        // Initial step
        updateProgress();

        // Animate through steps
        const interval = setInterval(() => {
          if (currentStep < steps.length) {
            updateProgress();
          } else {
            clearInterval(interval);
          }
        }, 800); // 800ms between steps for realistic timing
      }

      // Initialize budget mode event listeners
      document.addEventListener("DOMContentLoaded", function () {
        const budgetModeRadios = document.querySelectorAll(
          'input[name="budgetMode"]'
        );
        budgetModeRadios.forEach((radio) => {
          radio.addEventListener("change", toggleBudgetMode);
        });

        // Add event listener for investment objective changes
        const investmentObjectiveSelect = document.getElementById(
          "investmentObjective"
        );
        if (investmentObjectiveSelect) {
          investmentObjectiveSelect.addEventListener("change", function () {
            if (
              utils.calculationResults &&
              window.balanceSheet &&
              typeof balanceSheet.updateModelSynopsis === "function"
            ) {
              balanceSheet.updateModelSynopsis();
              console.log(
                "📊 Updated Investment Strategy Overview for new objective"
              );
            }
          });
        }

        // Add event listener for risk tolerance changes
        const riskToleranceSelect = document.getElementById("riskTolerance");
        if (riskToleranceSelect) {
          riskToleranceSelect.addEventListener("change", function () {
            if (
              utils.calculationResults &&
              window.balanceSheet &&
              typeof balanceSheet.updateModelSynopsis === "function"
            ) {
              balanceSheet.updateModelSynopsis();
              console.log(
                "📊 Updated Investment Strategy Overview for new risk tolerance"
              );
            }
          });
        }

        // Add event listeners for financing profile controls
        const financeSourceRadios = document.querySelectorAll(
          'input[name="financeSource"]'
        );
        financeSourceRadios.forEach((radio) => {
          radio.addEventListener("change", updateFinanceSourceDescription);
        });

        const creditScoreSlider = document.getElementById("creditScore");
        if (creditScoreSlider) {
          creditScoreSlider.addEventListener("input", updateCreditScoreDisplay);
          creditScoreSlider.addEventListener(
            "change",
            updateCreditScoreDisplay
          );
          creditScoreSlider.addEventListener("click", function () {
            console.log("Credit score slider clicked");
          });
          console.log("Credit score slider events attached");
        } else {
          console.log("Credit score slider not found during event attachment");
        }

        const financingTypeSlider = document.getElementById("financingType");
        if (financingTypeSlider) {
          financingTypeSlider.addEventListener(
            "input",
            updateFinancingTypeDisplay
          );
          financingTypeSlider.addEventListener(
            "change",
            updateFinancingTypeDisplay
          );
          financingTypeSlider.addEventListener("click", function () {
            console.log("Financing type slider clicked");
          });
          console.log("Financing type slider events attached");
        } else {
          console.log(
            "Financing type slider not found during event attachment"
          );
        }

        // Add click handlers for slider option cards
        document.querySelectorAll(".slider-option").forEach((option) => {
          option.addEventListener("click", function () {
            const value = this.dataset.value;
            const isFinancingType = this.closest(".financing-options") !== null;

            if (isFinancingType) {
              const slider = document.getElementById("financingType");
              if (slider) {
                slider.value = value;
                updateFinancingTypeDisplay();
              }
            } else {
              const slider = document.getElementById("creditScore");
              if (slider) {
                slider.value = value;
                updateCreditScoreDisplay();
              }
            }
          });
        });

        // Initialize financing profile displays
        updateFinanceSourceDescription();
        updateCreditScoreDisplay();
        updateFinancingTypeDisplay();

        // Initialize with default state
        toggleBudgetMode();
      });

      // Close dropdown when clicking outside
      document.addEventListener("click", function (event) {
        const menuDropdown = document.querySelector(".menu-dropdown");
        const dropdown = document.getElementById("nav-dropdown");

        if (!menuDropdown.contains(event.target)) {
          dropdown.classList.remove("show");
          menuDropdown.classList.remove("open");
        }
      });
    </script>
  </body>
</html>
