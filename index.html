<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Advanced Rental Property Investment Model</title>

    <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- CSS Files -->
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/summary.css" />
    <link rel="stylesheet" href="css/responsive.css" />
  </head>
  <body>
    <div class="container">
      <h1>Advanced Rental Property Investment Model</h1>

      <div class="tab-navigation">
        <!-- Mobile/Responsive Tab Menu -->
        <div class="tab-menu-container">
          <button class="tab-menu-toggle" onclick="toggleTabMenu()">
            <span class="menu-icon">â˜°</span>
            <span class="current-tab-name">Input Parameters</span>
            <span class="menu-arrow">â–¼</span>
          </button>
          <div class="tab-dropdown" id="tabDropdown">
            <button class="tab-option active" data-tab="inputs" onclick="selectTab('inputs', 'Input Parameters')">
              ğŸ“ Input Parameters
            </button>
            <button class="tab-option" data-tab="dashboard" onclick="selectTab('dashboard', 'ğŸ“Š Dashboard')">
              ğŸ“Š Dashboard
            </button>
            <button class="tab-option" data-tab="charts" onclick="selectTab('charts', 'ğŸ“ˆ Charts & Analysis')">
              ğŸ“ˆ Charts & Analysis
            </button>
            <button class="tab-option" data-tab="scenarios" onclick="selectTab('scenarios', 'ğŸ’¾ Scenarios')">
              ğŸ’¾ Scenarios
            </button>
            <button class="tab-option" data-tab="comparison" onclick="selectTab('comparison', 'Strategy Comparison')">
              ğŸ“Š Strategy Comparison
            </button>
            <button class="tab-option" data-tab="cashflow" onclick="selectTab('cashflow', 'Cash Flow Analysis')">
              ğŸ’° Cash Flow Analysis
            </button>
            <button class="tab-option" data-tab="sensitivity" onclick="selectTab('sensitivity', 'Sensitivity Analysis')">
              ğŸ¯ Sensitivity Analysis
            </button>
            <button class="tab-option" data-tab="breakeven" onclick="selectTab('breakeven', 'Break-Even Analysis')">
              âš–ï¸ Break-Even Analysis
            </button>
            <button class="tab-option" data-tab="roi" onclick="selectTab('roi', 'ROI Analysis')">
              ğŸ“ˆ ROI Analysis
            </button>
            <button class="tab-option" data-tab="summary" onclick="selectTab('summary', 'Summary & Download')">
              ğŸ“‹ Summary & Download
            </button>
            <button class="tab-option" data-tab="help" onclick="selectTab('help', 'Help')">
              â“ Help
            </button>
          </div>
        </div>

        <!-- Navigation Menu -->
        <div class="nav-menu">
          <div class="menu-dropdown">
            <button class="menu-button" onclick="toggleNavMenu()">
              <span class="menu-icon">âš™ï¸</span>
              <span class="current-tab-label">ğŸ“Š Dashboard</span>
              <span class="dropdown-arrow">â–¼</span>
            </button>
            <div class="dropdown-content" id="nav-dropdown">
              <button onclick="selectTab('inputs', 'âš™ï¸ Settings')">âš™ï¸ Settings</button>
              <button onclick="selectTab('dashboard', 'ğŸ“Š Dashboard')" class="active-menu-item">ğŸ“Š Dashboard</button>
              <button onclick="selectTab('charts', 'ğŸ“ˆ Charts & Analysis')">ğŸ“ˆ Charts & Analysis</button>
              <button onclick="selectTab('scenarios', 'ğŸ’¾ Scenarios')">ğŸ’¾ Scenarios</button>
              <button onclick="selectTab('comparison', 'ğŸ“Š Strategy Comparison')">ğŸ“Š Strategy Comparison</button>
              <button onclick="selectTab('cashflow', 'ğŸ’° Cash Flow Analysis')">ğŸ’° Cash Flow Analysis</button>
              <button onclick="selectTab('sensitivity', 'ğŸ¯ Sensitivity Analysis')">ğŸ¯ Sensitivity Analysis</button>
              <button onclick="selectTab('breakeven', 'âš–ï¸ Break-Even Analysis')">âš–ï¸ Break-Even Analysis</button>
              <button onclick="selectTab('roi', 'ğŸ“ˆ ROI Analysis')">ğŸ“ˆ ROI Analysis</button>
              <button onclick="selectTab('summary', 'ğŸ“‹ Summary & Download')">ğŸ“‹ Summary & Download</button>
              <button onclick="selectTab('help', 'â“ Help')">â“ Help</button>
            </div>
          </div>
        </div>
      </div>

      <div id="inputs" class="tab-content">
        <div class="input-form-container">
          <!-- Scrollable Form Area -->
          <div class="form-scroll-area">
            <div class="controls">
              <!-- AI Market Data Section -->
              <div class="control-group ai-controls">
                <h3>ğŸ¤– AI Market Analysis</h3>
                <div class="ai-toggle-section">
                  <label class="ai-toggle-label">
                    <input type="checkbox" id="useAIData" onchange="toggleAIData()">
                    <span class="ai-toggle-slider"></span>
                    Enable AI-Enhanced Market Projections
                  </label>
                  <div class="ai-status" id="ai-status">Static model - Enable AI for real market data</div>
                </div>
                
                <div class="ai-settings" id="ai-settings" style="display: none;">
                  <div class="control-group">
                    <h4>ğŸ“ Property Location</h4>
                    <div class="location-inputs">
                      <input type="text" id="city" placeholder="City (e.g., Austin)" style="width: 120px;">
                      <select id="state" style="width: 100px;">
                        <option value="">State</option>
                        <option value="California">CA</option>
                        <option value="Texas">TX</option>
                        <option value="Florida">FL</option>
                        <option value="New York">NY</option>
                        <option value="Illinois">IL</option>
                        <option value="Georgia">GA</option>
                        <option value="North Carolina">NC</option>
                        <option value="Arizona">AZ</option>
                        <option value="Colorado">CO</option>
                        <option value="Washington">WA</option>
                        <option value="Oregon">OR</option>
                      </select>
                      <input type="text" id="zipCode" placeholder="ZIP (optional)" style="width: 100px;">
                    </div>
                  </div>
                  
                  <div class="control-group">
                    <label for="propertyType">ğŸ  Property Type</label>
                    <select id="propertyType">
                      <option value="single-family">Single Family Home</option>
                      <option value="condo">Condominium</option>
                      <option value="townhouse">Townhouse</option>
                      <option value="multi-family">Multi-Family (2-4 units)</option>
                    </select>
                  </div>
                  
                  <div class="control-group">
                    <h4>ğŸ“Š AI Data Sources</h4>
                    <div class="ai-overrides">
                      <label>
                        <input type="checkbox" id="useAIAppreciation" checked>
                        Property Price Trends (Zillow + AI)
                      </label>
                      <label>
                        <input type="checkbox" id="useAIRentGrowth" checked>
                        Rent Growth Projections (Rentometer + AI)
                      </label>
                      <label>
                        <input type="checkbox" id="useAIInterestRates" checked>
                        Interest Rate Forecasts (Federal Reserve + AI)
                      </label>
                      <label>
                        <input type="checkbox" id="useAIMarketInsights" checked>
                        Market Insights & Risk Analysis (AI)
                      </label>
                    </div>
                  </div>
                  
                  <div class="ai-data-preview" id="ai-data-preview" style="display: none;">
                    <h4>ğŸ“ˆ Current AI Projections</h4>
                    <div class="ai-preview-content">
                      <!-- Will be populated when AI data is fetched -->
                    </div>
                  </div>
                </div>
              </div>

              <div class="control-group">
                <label>Annual Investment Budget ($)</label>
                <input type="number" id="annualBudget" value="170000" min="0" />
              </div>
              <div
                class="control-group highlighted-control"
                style="border: 2px solid #667eea; border-radius: 4px; padding: 8px"
              >
                <label style="color: #667eea; font-weight: bold"
                  >Investment Budget (Years)</label
                >
                <input
                  type="number"
                  id="selfPurchaseYears"
                  value="3"
                  min="0"
                  max="30"
                />
              </div>
              <div class="control-group">
                <label>Initial Property Cost ($)</label>
                <input type="number" id="initialCost" value="160000" min="0" />
              </div>
              <div class="control-group">
                <label>Monthly Rent as % of Purchase Price (%)</label>
                <input
                  type="number"
                  id="rentalRate"
                  value="1.9"
                  step="0.1"
                  min="0"
                />
              </div>
              <div class="control-group">
                <label>Mortgage Interest Rate (%)</label>
                <input
                  type="number"
                  id="interestRate"
                  value="7.00"
                  step="0.01"
                  min="0"
                />
              </div>
              <div class="control-group">
                <label>Loan-to-Value Ratio (%)</label>
                <input type="number" id="ltvRatio" value="70" min="0" max="100" />
              </div>
              <div class="control-group">
                <label>Loan Term (Years)</label>
                <input type="number" id="loanTerm" value="5" min="1" max="30" />
              </div>
              <div class="control-group">
                <label>Insurance per Unit per Year ($)</label>
                <input type="number" id="insurance" value="1300" min="0" />
              </div>
              <div class="control-group">
                <label>Land Value (% of cost)</label>
                <input
                  type="number"
                  id="landPercent"
                  value="20"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Maintenance (% of Effective Gross Income)</label>
                <input
                  type="number"
                  id="maintenanceRate"
                  value="1"
                  step="0.1"
                  min="0"
                />
              </div>
              <div class="control-group">
                <label>Annual Purchase Cost Increase (%)</label>
                <input
                  type="number"
                  id="costIncrease"
                  value="1"
                  step="0.1"
                  min="0"
                />
              </div>
              <div class="control-group">
                <label>Property Tax Rate (% of assessed value)</label>
                <input
                  type="number"
                  id="taxRate"
                  value="1.5"
                  step="0.1"
                  min="0"
                  max="10"
                />
              </div>
              <div class="control-group">
                <label>Income Tax Rate (%)</label>
                <input
                  type="number"
                  id="incomeTaxRate"
                  value="25"
                  min="0"
                  max="50"
                />
              </div>
              <div
                class="control-group highlighted-control"
                style="border: 2px solid #28a745; border-radius: 4px; padding: 8px"
              >
                <label style="color: #28a745; font-weight: bold"
                  >Passthrough LLC?</label
                >
                <select id="passthroughLLC" style="border-color: #28a745">
                  <option value="yes">Yes - No entity taxes</option>
                  <option value="no">No - Corporate taxation</option>
                </select>
              </div>
              <div class="control-group">
                <label>Assessed Value at Purchase (% of cost)</label>
                <input
                  type="number"
                  id="assessedValuePercent"
                  value="20"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Annual Property Appreciation (%)</label>
                <input
                  type="number"
                  id="appreciationRate"
                  value="3"
                  step="0.1"
                  min="0"
                />
              </div>
              <div
                class="control-group highlighted-control"
                style="border: 2px solid #667eea; border-radius: 4px; padding: 8px"
              >
                <label style="color: #667eea; font-weight: bold"
                  >Finance Purchases (Years)</label
                >
                <input
                  type="number"
                  id="financedPurchaseYears"
                  value="5"
                  min="0"
                  max="30"
                />
              </div>
              <div
                class="control-group highlighted-control"
                style="border: 2px solid #667eea; border-radius: 4px; padding: 8px"
              >
                <label style="color: #667eea; font-weight: bold"
                  >Max Units Financed</label
                >
                <input
                  type="number"
                  id="maxUnitsFinanced"
                  value="2"
                  min="1"
                  max="10"
                />
              </div>
              <div
                class="control-group highlighted-control"
                style="border: 2px solid #667eea; border-radius: 4px; padding: 8px"
              >
                <label style="color: #667eea; font-weight: bold"
                  >Max Units Financed Limit (Years)</label
                >
                <input
                  type="number"
                  id="maxUnitsFinancedLimitYears"
                  value="3"
                  min="1"
                  max="10"
                />
              </div>
              <div class="control-group">
                <label>Annual Rent Growth (%)</label>
                <input
                  type="number"
                  id="rentGrowthRate"
                  value="3"
                  step="0.1"
                  min="0"
                />
              </div>
              <div class="control-group">
                <label>Vacancy Rate (% of GPR)</label>
                <input
                  type="number"
                  id="vacancyRate"
                  value="5"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Management Fee (% of EGI)</label>
                <input
                  type="number"
                  id="managementRate"
                  value="8"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>CapEx Reserves (% of EGI)</label>
                <input
                  type="number"
                  id="capexRate"
                  value="5"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Expense Inflation (Insurance/Other) (%)</label>
                <input
                  type="number"
                  id="expenseInflation"
                  value="2.5"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Insurance Inflation (%)</label>
                <input
                  type="number"
                  id="insuranceInflation"
                  value="4"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Closing Costs (% of Purchase Price)</label>
                <input
                  type="number"
                  id="closingCostPercent"
                  value="2"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Loan Origination Fee (% of Loan)</label>
                <input
                  type="number"
                  id="loanOriginationPercent"
                  value="1"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
              <div class="control-group">
                <label>Assessed Value Growth (%)</label>
                <input
                  type="number"
                  id="assessedGrowthRate"
                  value="2.5"
                  step="0.1"
                  min="0"
                  max="100"
                />
              </div>
            </div>
          </div>


          <!-- Fixed Calculate Button Area -->
          <div class="calculate-button-area">
            <button class="calculate-btn" onclick="calculateAll()">
              Calculate Investment Scenarios
            </button>
          </div>
        </div>

        <!-- Current Scenario Display -->
        <div id="current-scenario" style="display: none"></div>
      </div>

      <!-- Dashboard Tab -->
      <div id="dashboard" class="tab-content active">
        <h2>ğŸ“Š Investment Dashboard</h2>

        <!-- Alert System -->
        <div id="alert-container" class="alert-container"></div>

        <!-- KPI Overview -->
        <div class="dashboard">
          <div class="dashboard-section">
            <h3>Self-Financed Strategy KPIs</h3>
            <div class="kpi-grid">
              <div class="kpi-tile">
                <div class="kpi-label">Final Net Worth</div>
                <div class="kpi-value" id="self-net-worth">$0</div>
              </div>
              <div class="kpi-tile">
                <div class="kpi-label">Cumulative Cash Flow</div>
                <div class="kpi-value" id="self-cash-flow">$0</div>
              </div>
              <div class="kpi-tile">
                <div class="kpi-label">Total ROI</div>
                <div class="kpi-value" id="self-roi">0%</div>
              </div>
            </div>
          </div>

          <div class="dashboard-section">
            <h3>Bank-Financed Strategy KPIs</h3>
            <div class="kpi-grid">
              <div class="kpi-tile">
                <div class="kpi-label">Final Net Worth</div>
                <div class="kpi-value" id="financed-net-worth">$0</div>
              </div>
              <div class="kpi-tile">
                <div class="kpi-label">Cumulative Cash Flow</div>
                <div class="kpi-value" id="financed-cash-flow">$0</div>
              </div>
              <div class="kpi-tile">
                <div class="kpi-label">Total ROI</div>
                <div class="kpi-value" id="financed-roi">0%</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Comparison Cards -->
        <div class="comparison-cards">
          <div class="comparison-card self-financed">
            <h4>ğŸ  Self-Financed Advantage</h4>
            <div class="comparison-metrics">
              <div class="metric">
                <div class="metric-label">Net Worth Advantage</div>
                <div class="metric-value" id="net-worth-diff">$0</div>
              </div>
              <div class="metric">
                <div class="metric-label">Cash Flow Advantage</div>
                <div class="metric-value" id="cash-flow-diff">$0</div>
              </div>
            </div>
          </div>

          <div class="comparison-card financed">
            <h4>ğŸ¦ Bank-Financed Benefits</h4>
            <div class="comparison-metrics">
              <div class="metric">
                <div class="metric-label">Leverage Multiplier</div>
                <div class="metric-value" id="leverage-multiplier">1.0x</div>
                <div class="metric-description">Asset control per equity dollar</div>
              </div>
              <div class="metric">
                <div class="metric-label">Unit Efficiency</div>
                <div class="metric-value" id="units-per-dollar">0.0</div>
                <div class="metric-description">Units acquired per $1K invested</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Negative Cash Flow Analysis -->
        <div class="dashboard-section" id="negative-cashflow-section" style="display: none;">
          <h3>âš ï¸ Cash Flow Challenges</h3>
          <div class="alert-warning" style="margin-bottom: 15px;">
            <strong>Negative Cash Flow Years Detected</strong><br>
            Some years show negative closing cash flow, which may require additional funding or cash reserves.
          </div>
          <div class="comparison-cards" id="negative-cashflow-cards">
            <div class="comparison-card" id="self-negative-card" style="border-left: 4px solid #ff6b6b; display: none;">
              <h4>ğŸ’° Self-Financed Strategy</h4>
              <div id="self-negative-years" class="negative-years-list">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
            <div class="comparison-card" id="financed-negative-card" style="border-left: 4px solid #ff6b6b; display: none;">
              <h4>ğŸ¦ Bank-Financed Strategy</h4>
              <div id="financed-negative-years" class="negative-years-list">
                <!-- Will be populated by JavaScript -->
              </div>
            </div>
          </div>
        </div>

        <!-- AI Market Insights -->
        <div class="dashboard-section" id="ai-insights-section" style="display: none;">
          <h3>ğŸ¤– AI Market Analysis</h3>
          <div class="ai-insights-container">
            <div class="ai-insight-card">
              <h4>ğŸ“Š Market Conditions</h4>
              <div id="ai-market-conditions" class="ai-insight-content">
                <!-- Will be populated by AI analysis -->
              </div>
            </div>
            <div class="ai-insight-card">
              <h4>âš ï¸ Risk Factors</h4>
              <div id="ai-risk-factors" class="ai-insight-content">
                <!-- Will be populated by AI analysis -->
              </div>
            </div>
            <div class="ai-insight-card">
              <h4>ğŸ¯ Investment Opportunities</h4>
              <div id="ai-opportunities" class="ai-insight-content">
                <!-- Will be populated by AI analysis -->
              </div>
            </div>
          </div>
          <div class="ai-data-source">
            <small>ğŸ’¡ AI analysis based on current market data and trends for <span id="ai-location-display"></span></small>
          </div>
        </div>

        <!-- Quick Actions -->
        <div class="dashboard-section">
          <h3>Quick Actions</h3>
          <div style="display: flex; gap: 15px; flex-wrap: wrap">
            <button
              class="btn btn-primary"
              onclick="scenarioManager.showSaveDialog()"
            >
              ğŸ’¾ Save Scenario
            </button>
            <button
              class="btn btn-secondary"
              onclick="workerManager.performSensitivityAnalysis(utils.getInputParameters())"
            >
              ğŸ¯ Sensitivity Analysis
            </button>
            <button
              class="btn btn-secondary"
              onclick="workerManager.performMonteCarloSimulation(utils.getInputParameters())"
            >
              ğŸ² Monte Carlo Simulation
            </button>
            <button
              class="btn btn-success"
              onclick="exportCurrentResultsToPDF()"
            >
              ğŸ“„ Export PDF Report
            </button>
          </div>
        </div>
      </div>

      <!-- Charts & Analysis Tab -->
      <div id="charts" class="tab-content">
        <h2>ğŸ“ˆ Charts & Visual Analysis</h2>

        <div class="charts-grid">
          <!-- Cash Flow Waterfall Chart -->
          <div class="chart-container">
            <h3>Cash Flow Waterfall Analysis</h3>
            <div class="chart-wrapper">
              <canvas id="cashFlowWaterfallChart"></canvas>
            </div>
          </div>

          <!-- Net Worth Progression Chart -->
          <div class="chart-container">
            <h3>Net Worth & Cash Flow Progression</h3>
            <div class="chart-wrapper">
              <canvas id="netWorthChart"></canvas>
            </div>
          </div>

          <!-- Sensitivity Tornado Chart -->
          <div class="chart-container">
            <h3>Sensitivity Analysis</h3>
            <div class="chart-wrapper">
              <canvas id="sensitivityChart"></canvas>
            </div>
          </div>
        </div>

        <!-- Advanced Analysis Results -->
        <div id="sensitivity-results"></div>
        <div id="monte-carlo-results"></div>
      </div>

      <!-- Scenarios Tab -->
      <div id="scenarios" class="tab-content">
        <h2>ğŸ’¾ Scenario Management</h2>

        <div class="dashboard-section">
          <h3>Scenario Actions</h3>
          <div
            style="
              display: flex;
              gap: 15px;
              flex-wrap: wrap;
              margin-bottom: 20px;
            "
          >
            <button
              class="btn btn-primary"
              onclick="scenarioManager.showSaveDialog()"
            >
              ğŸ’¾ Save Current Scenario
            </button>
            <button
              class="btn btn-secondary"
              onclick="document.getElementById('import-file').click()"
            >
              ğŸ“¥ Import Scenarios
            </button>
            <button class="btn btn-secondary" onclick="exportAllScenarios()">
              ğŸ“¤ Export All Scenarios
            </button>
            <input
              type="file"
              id="import-file"
              accept=".json"
              style="display: none"
              onchange="handleScenarioImport(this)"
            />
          </div>
        </div>

        <!-- Scenarios List -->
        <div class="dashboard-section">
          <h3>Saved Scenarios</h3>
          <div id="scenarios-list">
            <div class="no-scenarios">No saved scenarios</div>
          </div>
        </div>

        <!-- Scenario Comparison -->
        <div class="dashboard-section">
          <h3>Scenario Comparison</h3>
          <div id="scenario-comparison">
            <p>Select multiple scenarios to compare their results.</p>
          </div>
        </div>
      </div>

      <div id="comparison" class="tab-content">
        <h2>Strategy Comparison (With Cash Flow Reinvestment)</h2>
        <div class="table-container">
          <table id="comparisonTable">
            <thead>
              <tr>
                <th rowspan="2">Year</th>
                <th rowspan="2">Property<br />Cost</th>
                <th
                  colspan="4"
                  style="
                    background: linear-gradient(45deg, #28a745, #20c997);
                    text-align: center;
                  "
                >
                  Self Financed
                </th>
                <th
                  colspan="6"
                  style="
                    background: linear-gradient(45deg, #667eea, #764ba2);
                    text-align: center;
                  "
                >
                  Bank Financed
                </th>
              </tr>
              <tr>
                <th>New<br />Units</th>
                <th>Total<br />Units</th>
                <th>Closing<br />Cash</th>
                <th>Asset<br />Value</th>
                <th>New<br />Units</th>
                <th>Total<br />Units</th>
                <th>Closing<br />Cash</th>
                <th>Asset<br />Value</th>
                <th>Loan<br />Balance</th>
                <th>Net<br />Equity</th>
              </tr>
            </thead>
            <tbody id="comparisonBody"></tbody>
          </table>
        </div>
      </div>

      <div id="cashflow" class="tab-content">
        <h2>15-Year Cash Flow Analysis</h2>
        <div class="table-container">
          <table id="cashflowTable" class="cashflow-analysis-table">
            <thead>
              <tr>
                <th rowspan="2">Year</th>
                <th
                  colspan="5"
                  style="
                    background: linear-gradient(45deg, #28a745, #20c997);
                    text-align: center;
                  "
                >
                  Self Financed Strategy
                </th>
                <th
                  colspan="7"
                  style="
                    background: linear-gradient(45deg, #667eea, #764ba2);
                    text-align: center;
                  "
                >
                  Bank Financed Strategy
                </th>
              </tr>
              <tr>
                <th>Opening<br />Cash</th>
                <th>Cash<br />Inflows</th>
                <th>Cash<br />Outflows</th>
                <th>Net<br />Cash Flow</th>
                <th>Closing<br />Cash</th>
                <th>Opening<br />Cash</th>
                <th>Cash<br />Inflows</th>
                <th>Cash<br />Outflows</th>
                <th>Net<br />Cash Flow</th>
                <th>Closing<br />Cash</th>
                <th>Opening<br />Loan</th>
                <th>Closing<br />Loan</th>
              </tr>
            </thead>
            <tbody id="cashflowBody"></tbody>
          </table>
        </div>
      </div>

      <div id="sensitivity" class="tab-content">
        <h2>Sensitivity Analysis</h2>
        <p>
          See how changes in key parameters affect your investment outcomes.
          Each parameter is varied by Â±10%, Â±20%, and Â±30% from your base case.
        </p>

        <h3>Net Worth Impact (15-Year)</h3>
        <div class="table-container">
          <table id="sensitivityNetWorthTable">
            <thead>
              <tr>
                <th>Parameter</th>
                <th>-30%</th>
                <th>-20%</th>
                <th>-10%</th>
                <th>Base Case</th>
                <th>+10%</th>
                <th>+20%</th>
                <th>+30%</th>
              </tr>
            </thead>
            <tbody id="sensitivityNetWorthBody"></tbody>
          </table>
        </div>
      </div>

      <div id="breakeven" class="tab-content">
        <h2>Break-Even Analysis</h2>
        <p>
          Understand when your investment becomes profitable and what conditions
          are needed for target returns.
        </p>

        <div class="summary-cards">
          <div class="card">
            <h3>Cash Flow Break-Even</h3>
            <div class="value" id="cashFlowBreakEven">Year 0</div>
            <p>When annual cash flow turns positive</p>
          </div>
          <div class="card">
            <h3>ROI Break-Even</h3>
            <div class="value" id="roiBreakEven">Year 0</div>
            <p>When returns exceed 10% annually</p>
          </div>
        </div>
      </div>

      <div id="summary" class="tab-content">
        <!-- Header Section -->
        <div class="summary-header">
          <div class="summary-title">
            <h2>ğŸ“‹ Investment Analysis Summary</h2>
            <p>15-Year Investment Strategy Comparison</p>
          </div>
          <div class="summary-period">
            <div class="period-badge">
              <span class="period-label">Analysis Period</span>
              <span class="period-value">15 Years</span>
            </div>
          </div>
        </div>

        <!-- Strategy Comparison Section -->
        <div class="strategy-comparison-grid">
          <!-- Self-Financed Strategy -->
          <div class="strategy-section self-financed">
            <div class="strategy-header">
              <div class="strategy-icon">ğŸ¦</div>
              <div class="strategy-info">
                <h3>Self-Financed Strategy</h3>
                <p>Pay cash, own outright</p>
              </div>
            </div>
            <div class="strategy-metrics">
              <div class="metric-card">
                <div class="metric-icon">ğŸ˜ï¸</div>
                <div class="metric-info">
                  <div class="metric-label">Total Units</div>
                  <div class="metric-value" id="totalSelfUnits">0</div>
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">ğŸ’</div>
                <div class="metric-info">
                  <div class="metric-label">Final Net Worth</div>
                  <div class="metric-value" id="selfNetWorth">$0</div>
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">ğŸ’°</div>
                <div class="metric-info">
                  <div class="metric-label">Total Cash Flow</div>
                  <div class="metric-value" id="selfCumulative">$0</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Bank-Financed Strategy -->
          <div class="strategy-section bank-financed">
            <div class="strategy-header">
              <div class="strategy-icon">ğŸ›ï¸</div>
              <div class="strategy-info">
                <h3>Bank-Financed Strategy</h3>
                <p>Leverage with mortgages</p>
              </div>
            </div>
            <div class="strategy-metrics">
              <div class="metric-card">
                <div class="metric-icon">ğŸ˜ï¸</div>
                <div class="metric-info">
                  <div class="metric-label">Total Units</div>
                  <div class="metric-value" id="totalFinancedUnits">0</div>
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">ğŸ’</div>
                <div class="metric-info">
                  <div class="metric-label">Final Net Worth</div>
                  <div class="metric-value" id="financedNetWorth">$0</div>
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-icon">ğŸ’°</div>
                <div class="metric-info">
                  <div class="metric-label">Total Cash Flow</div>
                  <div class="metric-value" id="financedCumulative">$0</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Key Insights Section -->
        <div class="insights-section">
          <div class="insights-header">
            <h3>ğŸ“Š Key Performance Indicators</h3>
          </div>
          <div class="insights-grid">
            <div class="insight-card">
              <div class="insight-icon">âš–ï¸</div>
              <div class="insight-content">
                <div class="insight-label">Net Worth Difference</div>
                <div class="insight-value" id="netWorthDifference">-</div>
                <div class="insight-description">Advantage to bank financing</div>
              </div>
            </div>
            <div class="insight-card">
              <div class="insight-icon">ğŸ“ˆ</div>
              <div class="insight-content">
                <div class="insight-label">Unit Acquisition</div>
                <div class="insight-value" id="unitDifference">-</div>
                <div class="insight-description">Additional units with leverage</div>
              </div>
            </div>
            <div class="insight-card">
              <div class="insight-icon">ğŸ’µ</div>
              <div class="insight-content">
                <div class="insight-label">Cash Flow Impact</div>
                <div class="insight-value" id="cashFlowDifference">-</div>
                <div class="insight-description">Difference in total cash flow</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Recommendation Section -->
        <div id="recommendation" class="recommendation-section"></div>

        <!-- Action Section -->
        <div class="action-section">
          <div class="action-header">
            <h3>ğŸ“„ Export & Share</h3>
            <p>Download detailed reports for further analysis</p>
          </div>
          <div class="action-buttons">
            <button class="download-btn primary" onclick="downloadExcel()">
              <span class="btn-icon">ğŸ“Š</span>
              <span class="btn-text">
                <span class="btn-label">Download Excel</span>
                <span class="btn-description">Complete analysis report</span>
              </span>
            </button>
            <button class="download-btn secondary" onclick="window.print()">
              <span class="btn-icon">ğŸ–¨ï¸</span>
              <span class="btn-text">
                <span class="btn-label">Print Summary</span>
                <span class="btn-description">Quick reference sheet</span>
              </span>
            </button>
          </div>
        </div>
      </div>

      <!-- ROI Analysis Tab -->
      <div id="roi" class="tab-content">
        <h2>Return on Investment Analysis</h2>
        <p style="margin-bottom: 20px; color: #666">
          Compare real estate returns against alternative investments
        </p>

        <div id="roiCards">
          <!-- ROI cards will be populated by JavaScript -->
        </div>

        <div class="table-container">
          <h3>Investment Comparison</h3>
          <table>
            <thead>
              <tr>
                <th>Investment Type</th>
                <th>Initial Investment</th>
                <th>Final Value</th>
                <th>Total Return</th>
                <th>Annual ROI</th>
                <th>Risk Level</th>
              </tr>
            </thead>
            <tbody id="roiComparisonBody">
              <tr>
                <td colspan="6" style="text-align: center; color: #666">
                  Run calculations to see ROI comparison
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="table-container">
          <h3>Year-by-Year Value Comparison</h3>
          <table>
            <thead>
              <tr>
                <th>Year</th>
                <th>Real Estate (Self)</th>
                <th>Real Estate (Financed)</th>
                <th>S&P 500</th>
                <th>Bonds</th>
                <th>Savings Account</th>
              </tr>
            </thead>
            <tbody id="roiYearlyBody">
              <tr>
                <td colspan="6" style="text-align: center; color: #666">
                  Run calculations to see yearly comparison
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Help Tab -->
      <div id="help" class="tab-content">
        <h2>Help & Documentation</h2>

        <div
          style="
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
          "
        >
          <h3>ğŸ“– How to Use This Model</h3>
          <ol style="margin-left: 20px; line-height: 1.8">
            <li>
              <strong>Input Parameters:</strong> Set your investment parameters
              in the first tab
            </li>
            <li>
              <strong>Calculate:</strong> Click the "Calculate" button to run
              the analysis
            </li>
            <li>
              <strong>Review Results:</strong> Check all tabs for comprehensive
              analysis
            </li>
            <li>
              <strong>Download:</strong> Export results to Excel for further
              analysis
            </li>
          </ol>
        </div>

        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
          "
        >
          <div
            style="
              background: white;
              padding: 20px;
              border-radius: 10px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            "
          >
            <h3>ğŸ  Investment Strategies</h3>
            <p>
              <strong>Self-Financed:</strong> Purchase properties with 100%
              cash, no debt
            </p>
            <p>
              <strong>Bank-Financed:</strong> Use leverage with 70% LTV
              mortgages
            </p>
            <p>
              <strong>Comparison:</strong> Model compares both strategies over
              15 years
            </p>
          </div>

          <div
            style="
              background: white;
              padding: 20px;
              border-radius: 10px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            "
          >
            <h3>ğŸ’° Key Metrics Explained</h3>
            <p><strong>Cash Flow:</strong> Annual income minus expenses</p>
            <p><strong>Net Worth:</strong> Property value + cash - debt</p>
            <p><strong>ROI:</strong> Annualized return on investment</p>
            <p>
              <strong>Break-Even:</strong> Year when strategy becomes profitable
            </p>
          </div>

          <div
            style="
              background: white;
              padding: 20px;
              border-radius: 10px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            "
          >
            <h3>ğŸ“Š Analysis Tabs</h3>
            <p>
              <strong>Strategy Comparison:</strong> Side-by-side year-by-year
              comparison
            </p>
            <p>
              <strong>Cash Flow Analysis:</strong> Detailed cash flow breakdown
            </p>
            <p>
              <strong>Sensitivity Analysis:</strong> Impact of parameter changes
            </p>
            <p><strong>Break-Even Analysis:</strong> Profitability timeline</p>
            <p>
              <strong>ROI Analysis:</strong> Returns vs alternative investments
            </p>
          </div>

          <div
            style="
              background: white;
              padding: 20px;
              border-radius: 10px;
              box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            "
          >
            <h3>âš™ï¸ Important Parameters</h3>
            <p>
              <strong>Annual Budget:</strong> Available cash for investments
            </p>
            <p>
              <strong>Rental Rate:</strong> Monthly rent as % of property cost
            </p>
            <p><strong>Interest Rate:</strong> Mortgage interest rate</p>
            <p><strong>LTV Ratio:</strong> Loan-to-value ratio for financing</p>
            <p>
              <strong>Appreciation Rate:</strong> Annual property value growth
            </p>
          </div>
        </div>

        <div
          style="
            background: #e3f2fd;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border-left: 4px solid #2196f3;
          "
        >
          <h3>ğŸ’¡ Tips for Best Results</h3>
          <ul style="margin-left: 20px; line-height: 1.8">
            <li>
              Use realistic rental rates (typically 0.8-1.2% of property value)
            </li>
            <li>Consider local market conditions for appreciation rates</li>
            <li>Account for property management and maintenance costs</li>
            <li>Factor in tax implications of your investment structure</li>
            <li>
              Compare results with your investment goals and risk tolerance
            </li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Year Detail Modal -->
    <div id="yearModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <button
            class="nav-btn"
            id="prevYearBtn"
            onclick="navigateToYear(utils.currentModalIndex - 1)"
            title="Previous Year"
          >
            &lt;
          </button>
          <div class="modal-title">
            <h2>Year <span id="modalYear"></span> - Detailed Analysis</h2>
          </div>
          <div class="modal-controls">
            <select
              id="strategySelect"
              class="modal-dropdown"
              onchange="switchStrategy(this.value)"
            >
              <option value="self">Self-Financed</option>
              <option value="financed">Bank-Financed</option>
            </select>
            <select
              id="statementSelect"
              class="modal-dropdown"
              onchange="showModalTab(this.value)"
            >
              <option value="pl">P&L Statement</option>
              <option value="balance">Balance Sheet</option>
              <option value="cashflow">Cash Flow</option>
            </select>
            <button
              class="nav-btn"
              id="nextYearBtn"
              onclick="navigateToYear(utils.currentModalIndex + 1)"
              title="Next Year"
            >
              &gt;
            </button>
            <span class="close" onclick="closeModal()">&times;</span>
          </div>
        </div>

        <div class="modal-body">
          <div class="modal-selection-display">
            <span id="selectedStrategy">Self-Financed</span> â€¢
            <span id="selectedStatement">P&L Statement</span>
          </div>

          <div id="plContent" class="modal-tab-content active">
            <table class="pl-table" id="plTable">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody id="plBody"></tbody>
            </table>
          </div>

          <div id="balanceContent" class="modal-tab-content">
            <table class="balance-table" id="balanceTable">
              <thead>
                <tr>
                  <th>Item</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody id="balanceBody"></tbody>
            </table>
          </div>

          <div id="cashflowContent" class="modal-tab-content">
            <table class="cashflow-table" id="modalCashflowTable">
              <thead>
                <tr>
                  <th>Cash Flow Item</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody id="modalCashflowBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript Files -->
    <script src="js/core/utils.js"></script>
    <script src="js/core/data-model.js"></script>
    <script src="js/core/calculations.js"></script>
    <script src="js/components/ui-manager.js"></script>
    <script src="test-modal-debug.js"></script>
    <script src="js/components/export.js"></script>
    <script src="js/components/worker-manager.js"></script>
    <script src="js/modules/roi-analysis.js"></script>
    <script src="js/modules/sensitivity-analysis.js"></script>
    <script src="js/modules/balance-sheet.js"></script>
    <script src="js/modules/ai-market-data.js"></script>
    <script src="js/modules/charts.js"></script>
    <script src="js/modules/scenario-manager.js"></script>
    <script src="js/modules/pdf-export.js"></script>
    <script src="js/app.js"></script>

    <!-- Helper Functions for UI -->
    <script>
      // Scenario import/export helper functions
      function exportAllScenarios() {
        try {
          const exportData = scenarioManager.exportScenarios();
          const blob = new Blob([exportData], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = `investment-scenarios-${
            new Date().toISOString().split("T")[0]
          }.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        } catch (error) {
          alert("Error exporting scenarios: " + error.message);
        }
      }

      function handleScenarioImport(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const result = scenarioManager.importScenarios(e.target.result, {
              generateNewIds: true,
              renameDuplicates: true,
            });

            let message = `Successfully imported ${result.imported.length} scenarios.`;
            if (result.errors.length > 0) {
              message += `\n${result.errors.length} scenarios failed to import.`;
            }
            alert(message);
          } catch (error) {
            alert("Error importing scenarios: " + error.message);
          }
        };
        reader.readAsText(file);
        input.value = ""; // Reset file input
      }

      // AI Control Functions
      function toggleAIData() {
        const checkbox = document.getElementById('useAIData');
        const settings = document.getElementById('ai-settings');
        const status = document.getElementById('ai-status');
        
        if (checkbox.checked) {
          settings.style.display = 'block';
          status.textContent = 'AI enabled - Configure location and data sources';
          console.log("ğŸ¤– AI market data enabled");
        } else {
          settings.style.display = 'none';
          status.textContent = 'Static model - Enable AI for real market data';
          console.log("ğŸ“Š Using static model data");
        }
      }

      async function fetchAIProjections() {
        const useAI = document.getElementById('useAIData').checked;
        if (!useAI) return null;
        
        const location = {
          city: document.getElementById('city').value.trim(),
          state: document.getElementById('state').value,
          zipCode: document.getElementById('zipCode').value.trim()
        };
        
        const propertyType = document.getElementById('propertyType').value;
        
        if (!location.city || !location.state) {
          alert('Please enter city and state for AI market analysis');
          return null;
        }
        
        try {
          // Show loading status
          const status = document.getElementById('ai-status');
          const preview = document.getElementById('ai-data-preview');
          status.innerHTML = '<div class="ai-loading">Fetching AI market data...</div>';
          
          // Initialize AI service and get projections
          await window.aiMarketData.initialize(location, propertyType);
          const projections = await window.aiMarketData.getMarketProjections(location, propertyType, 15);
          
          // Update status
          status.textContent = `AI active - Last updated: ${new Date().toLocaleTimeString()}`;
          
          // Show preview
          updateAIDataPreview(projections);
          preview.style.display = 'block';
          
          return projections;
          
        } catch (error) {
          console.error('âŒ AI data fetch failed:', error);
          document.getElementById('ai-status').textContent = 'AI error - Using fallback data';
          return null;
        }
      }

      function updateAIDataPreview(projections) {
        const preview = document.querySelector('.ai-preview-content');
        if (!preview || !projections) return;
        
        const html = `
          <div><strong>ğŸ“ Location:</strong> ${projections.location.city}, ${projections.location.state}</div>
          <div><strong>ğŸ  Property Type:</strong> ${projections.propertyType}</div>
          <div><strong>ğŸ“ˆ Avg Property Growth:</strong> ${projections.avgPropertyAppreciation?.toFixed(1)}%/year</div>
          <div><strong>ğŸ  Avg Rent Growth:</strong> ${projections.avgRentGrowth?.toFixed(1)}%/year</div>
          <div><strong>ğŸ’° Avg Interest Rate:</strong> ${projections.avgInterestRate?.toFixed(2)}%</div>
          <div><strong>ğŸ¯ Market Conditions:</strong> ${projections.marketConditions}</div>
          <div><strong>ğŸ¤– Confidence:</strong> ${(projections.confidence * 100).toFixed(0)}%</div>
        `;
        preview.innerHTML = html;
      }

      // Apply AI projections to calculation parameters
      async function applyAIProjections(params, aiProjections) {
        console.log("ğŸ¤– Applying AI projections to parameters...");
        
        // Create enhanced parameters object
        const enhancedParams = { ...params };
        
        // Get AI override settings
        const useAIAppreciation = document.getElementById('useAIAppreciation').checked;
        const useAIRentGrowth = document.getElementById('useAIRentGrowth').checked;
        const useAIInterestRates = document.getElementById('useAIInterestRates').checked;
        
        if (useAIAppreciation && aiProjections.avgPropertyAppreciation) {
          enhancedParams.appreciationRate = aiProjections.avgPropertyAppreciation;
          console.log(`ğŸ“ˆ Using AI property appreciation: ${aiProjections.avgPropertyAppreciation.toFixed(1)}%`);
        }
        
        if (useAIRentGrowth && aiProjections.avgRentGrowth) {
          enhancedParams.rentGrowthRate = aiProjections.avgRentGrowth;
          console.log(`ğŸ  Using AI rent growth: ${aiProjections.avgRentGrowth.toFixed(1)}%`);
        }
        
        if (useAIInterestRates && aiProjections.avgInterestRate) {
          enhancedParams.interestRate = aiProjections.avgInterestRate;
          console.log(`ğŸ’° Using AI interest rate: ${aiProjections.avgInterestRate.toFixed(2)}%`);
        }
        
        // Add AI metadata to parameters
        enhancedParams.aiData = {
          enabled: true,
          projections: aiProjections,
          lastUpdated: new Date().toISOString(),
          location: aiProjections.location,
          propertyType: aiProjections.propertyType
        };
        
        console.log("âœ… AI projections applied to parameters");
        return enhancedParams;
      }

      // Initialize enhanced features when page loads
      document.addEventListener("DOMContentLoaded", function () {
        // Initialize worker manager
        workerManager.initWorker();

        // Load scenario list
        scenarioManager.updateScenariosList();

        // Add window resize handler for charts
        window.addEventListener("resize", function () {
          if (window.chartManager) {
            chartManager.resizeCharts();
          }
        });
      });

      // Tab Menu Functions
      function toggleTabMenu() {
        const dropdown = document.getElementById('tabDropdown');
        const toggle = document.querySelector('.tab-menu-toggle');
        
        if (dropdown.classList.contains('show')) {
          dropdown.classList.remove('show');
          toggle.classList.remove('active');
        } else {
          dropdown.classList.add('show');
          toggle.classList.add('active');
        }
      }

      function selectTab(tabId, tabName) {
        // Update current tab name
        document.querySelector('.current-tab-name').textContent = tabName;
        
        // Update active state in dropdown
        document.querySelectorAll('.tab-option').forEach(option => {
          option.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
        
        // Close dropdown
        const dropdown = document.getElementById('tabDropdown');
        const toggle = document.querySelector('.tab-menu-toggle');
        dropdown.classList.remove('show');
        toggle.classList.remove('active');
        
        // Activate the tab (reuse existing function)
        const fakeButton = { classList: { remove: () => {}, add: () => {} } };
        activateTab(fakeButton, tabId);
      }

      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        const menuContainer = document.querySelector('.tab-menu-container');
        if (menuContainer && !menuContainer.contains(event.target)) {
          const dropdown = document.getElementById('tabDropdown');
          const toggle = document.querySelector('.tab-menu-toggle');
          if (dropdown && toggle) {
            dropdown.classList.remove('show');
            toggle.classList.remove('active');
          }
        }
      });


      // Enhanced calculateAll that updates charts after calculation
      async function calculateAll() {
        try {
          let params = utils.getInputParameters();
          
          // Fetch AI market projections if enabled
          const aiProjections = await fetchAIProjections();
          if (aiProjections) {
            params = await applyAIProjections(params, aiProjections);
          }
          
          const validation = dataModel.validateInvestmentParameters(params);

          if (!validation.isValid) {
            alert(
              "Please fix the following errors:\n" +
                validation.errors.join("\n")
            );
            return;
          }

          console.log(
            "ğŸ” CALCULATE ALL: Using worker manager for calculations"
          );

          // Use worker manager for calculations (which will use worker or fall back to main thread)
          if (
            window.workerManager &&
            typeof workerManager.calculateScenarios === "function"
          ) {
            workerManager.calculateScenarios(params);
          } else {
            console.warn(
              "ğŸ” WORKER MANAGER NOT AVAILABLE, using direct calculation"
            );
            // Fallback to direct calculation
            const results = calculations.performCalculations(params);
            
            // Ensure summary metrics are calculated
            if (results && !results.summaryMetrics?.leverageMultiplier) {
              console.log("âš ï¸ Summary metrics incomplete, manually calling calculateSummaryMetrics...");
              try {
                calculations.calculateSummaryMetrics(results);
                console.log("âœ… Manual calculateSummaryMetrics completed in calculateAll");
              } catch (error) {
                console.error("âŒ calculateSummaryMetrics failed in calculateAll:", error);
              }
            }
            
            utils.calculationResults = results;

            if (typeof updateAllTables === "function") {
              updateAllTables();
            }
          }
        } catch (error) {
          console.error("Calculation error:", error);
          if (typeof utils.handleError === "function") {
            utils.handleError(error, "calculateAll");
          }
          alert(
            "An error occurred during calculations. Please check the console for details."
          );
        }
      }

      // Navigation dropdown functions
      function toggleNavMenu() {
        const dropdown = document.getElementById('nav-dropdown');
        const menuDropdown = document.querySelector('.menu-dropdown');
        
        if (dropdown.classList.contains('show')) {
          dropdown.classList.remove('show');
          menuDropdown.classList.remove('open');
        } else {
          dropdown.classList.add('show');
          menuDropdown.classList.add('open');
        }
      }

      function selectTab(tabId, tabLabel) {
        // Hide dropdown
        const dropdown = document.getElementById('nav-dropdown');
        const menuDropdown = document.querySelector('.menu-dropdown');
        dropdown.classList.remove('show');
        menuDropdown.classList.remove('open');
        
        // Update current tab label
        document.querySelector('.current-tab-label').textContent = tabLabel;
        
        // Update active menu item
        document.querySelectorAll('.dropdown-content button').forEach(btn => {
          btn.classList.remove('active-menu-item');
        });
        event.target.classList.add('active-menu-item');
        
        // Activate tab
        activateTab(null, tabId);
      }

      function activateTab(btn, tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(content => {
          content.classList.remove('active');
        });
        
        // Show selected tab
        const tabElement = document.getElementById(tabName);
        if (tabElement) {
          tabElement.classList.add('active');
        }
      }

      // Auto-location detection function
      async function detectUserLocation() {
        try {
          // Try geolocation API first
          if (navigator.geolocation) {
            return new Promise((resolve, reject) => {
              navigator.geolocation.getCurrentPosition(
                async (position) => {
                  try {
                    // Use a reverse geocoding service (you'd need an API key for production)
                    // For now, we'll use a fallback approach
                    resolve(await getLocationFromIP());
                  } catch (error) {
                    resolve(await getLocationFromIP());
                  }
                },
                () => {
                  // Geolocation failed, fall back to IP-based detection
                  resolve(getLocationFromIP());
                }
              );
            });
          } else {
            return await getLocationFromIP();
          }
        } catch (error) {
          console.warn('Location detection failed:', error);
          return { city: 'Austin', state: 'Texas' }; // Default fallback
        }
      }

      async function getLocationFromIP() {
        try {
          // Using a free IP geolocation service
          const response = await fetch('https://ipapi.co/json/', { timeout: 3000 });
          const data = await response.json();
          
          return {
            city: data.city || 'Austin',
            state: data.region || 'Texas'
          };
        } catch (error) {
          console.warn('IP-based location detection failed:', error);
          // Return default location
          return { city: 'Austin', state: 'Texas' };
        }
      }

      // Initialize app on page load
      window.addEventListener('DOMContentLoaded', async function() {
        console.log('ğŸš€ Initializing Investment Model...');
        
        try {
          // Auto-detect location and populate AI fields
          const location = await detectUserLocation();
          console.log('ğŸ“ Detected location:', location);
          
          // Populate AI location fields
          const cityInput = document.getElementById('city');
          const stateSelect = document.getElementById('state');
          
          if (cityInput) cityInput.value = location.city;
          if (stateSelect) {
            // Try to match state name to select options
            const stateOptions = stateSelect.options;
            for (let i = 0; i < stateOptions.length; i++) {
              if (stateOptions[i].value === location.state || 
                  stateOptions[i].text.includes(location.state)) {
                stateSelect.selectedIndex = i;
                break;
              }
            }
          }
          
          // Enable AI data if location detected successfully
          if (location.city && location.state) {
            const useAICheckbox = document.getElementById('useAIData');
            if (useAICheckbox && !useAICheckbox.checked) {
              useAICheckbox.checked = true;
              if (typeof toggleAIData === 'function') {
                toggleAIData();
              }
            }
          }
          
          // Auto-calculate after a short delay to let everything initialize
          setTimeout(async () => {
            console.log('ğŸ”„ Running initial calculations...');
            await calculateAll();
            
            // Navigate to dashboard tab for better UX
            selectTab('dashboard', 'ğŸ“Š Dashboard');
            console.log('âœ… App initialization complete');
          }, 1000);
          
        } catch (error) {
          console.error('âŒ App initialization error:', error);
          // Still run calculations even if location detection fails
          setTimeout(async () => {
            await calculateAll();
            selectTab('dashboard', 'ğŸ“Š Dashboard');
          }, 1000);
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        const menuDropdown = document.querySelector('.menu-dropdown');
        const dropdown = document.getElementById('nav-dropdown');
        
        if (!menuDropdown.contains(event.target)) {
          dropdown.classList.remove('show');
          menuDropdown.classList.remove('open');
        }
      });
    </script>
  </body>
</html>
